{% extends 'base.html' %}
{% load static %}

{% block meta %}
    <title>Soccer Club Map Directory</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Orbitron:wght@700&family=Tektur:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { font-family: 'Lato', sans-serif; background-color: #f8f9fa; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-tektur { font-family: 'Tektur', sans-serif; }
        .font-lato { font-family: 'Lato', sans-serif; }

        #map { height: 450px; position: relative; z-index: 10; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 15px rgba(255, 165, 0, 0); transform: scale(1.05); }
            100% { box-shadow: 0 0 0 0 rgba(255, 165, 0, 0); transform: scale(1); }
        }
        .league-icon-div {
            width: 52px; height: 52px; animation: pulse 2s infinite; border: 2px solid white;
            border-radius: 10px; cursor: pointer; background-color: rgba(255, 255, 255, 0.85);
            box-shadow: 0 3px 6px rgba(0,0,0,0.25); transition: transform 0.2s ease;
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        .league-icon-div:hover { transform: scale(1.1); }

        .leaflet-tooltip.league-tooltip {
             font-family: 'Tektur', sans-serif; font-size: 1rem; font-weight: 600;
             background-color: rgba(0, 0, 0, 0.7); color: white; border: none;
             box-shadow: none; padding: 4px 8px; border-radius: 4px;
        }

         .champion-slot {
             background-color: #ffffff; border: 2px dashed #d1d5db; border-radius: 0.75rem;
             padding: 1.5rem; display: flex; flex-direction: column; align-items: center;
             justify-content: center; text-align: center; color: #6b7280; cursor: pointer;
             transition: all 0.2s ease-in-out; min-height: 160px; position: relative;
             overflow: hidden; aspect-ratio: 4 / 3;
         }
         .champion-slot:hover { border-color: #fb923c; color: #f97316; }
         .champion-slot img.selected-logo { max-width: 72px; max-height: 72px; object-fit: contain; margin-bottom: 0.75rem; }
         .champion-slot .league-label {
            position: absolute; top: 8px; right: 8px; background-color: rgba(251, 146, 60, 0.8);
            color: white; font-size: 0.7rem; font-weight: bold; padding: 2px 6px;
            border-radius: 9999px; font-family: 'Lato', sans-serif;
         }
         .champion-slot .select-text { font-family: 'Tektur', sans-serif; font-size: 1.1rem; font-weight: 600;}
         .champion-slot .selected-club-name { font-family: 'Lato', sans-serif; font-size: 0.9rem; font-weight: 600; color: #1f2937; }

        #clubSelectorModal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 100;
            display: flex; align-items: center; justify-content: center; padding: 1rem;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out;
        }
        #clubSelectorModal.is-visible { opacity: 1; pointer-events: auto; }

        .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%; width: 600px; transform: scale(0.95);
            transition: transform 0.3s ease-in-out; overflow: hidden;
        }
        #clubSelectorModal.is-visible .modal-content { transform: scale(1); }

        .logo-scroll-outer-container {
             position: relative; margin: 1rem 0; padding: 1rem 0;
             border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb;
        }
        .logo-scroll-outer-container::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70px; height: 70px; border: 2px solid #fb923c; border-radius: 8px;
            pointer-events: none; box-shadow: 0 0 10px rgba(251, 146, 60, 0.5);
            z-index: 1; opacity: 0; transition: opacity 0.3s ease;
        }
         #clubSelectorModal.is-visible .logo-scroll-outer-container::after { opacity: 1; }

        .logo-scroll-container {
            display: flex; overflow-x: auto; white-space: nowrap; padding: 1rem 50%;
            gap: 1.5rem; min-height: 80px; align-items: center; scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .logo-scroll-container::-webkit-scrollbar { display: none; }

        .logo-scroll-container .tooltip-anchor, .logo-scroll-container .none-option-container {
             scroll-snap-align: center; flex: 0 0 auto; position: relative;
        }
        .logo-scroll-container img, .logo-scroll-container .none-option {
            height: 60px; width: 60px; object-fit: contain; cursor: pointer;
            transition: transform 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease;
            border: 3px solid transparent; border-radius: 8px; padding: 4px;
            background-color: #f9fafb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; color: #9ca3af;
        }
        .logo-scroll-container .none-option svg { width: 32px; height: 32px; }

        .logo-scroll-container img.is-center, .logo-scroll-container .none-option.is-center {
             transform: scale(1.15); border-color: #fb923c;
             box-shadow: 0 4px 10px rgba(251, 146, 60, 0.4);
         }
         .logo-scroll-container .none-option.is-center { color: #fb923c; }

         [data-tooltip]::before {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%) translateY(-5px) scale(0.9);
            background-color: #1f2937; color: white; padding: 5px 10px; border-radius: 5px;
            font-size: 0.8rem; font-weight: 600; white-space: nowrap; margin-bottom: 8px;
            z-index: 110; opacity: 0; pointer-events: none;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
         .logo-scroll-container .tooltip-anchor:has(.is-center)[data-tooltip]::before,
         .logo-scroll-container .none-option-container:has(.is-center)[data-tooltip]::before {
             opacity: 1; transform: translateX(-50%) translateY(0) scale(1);
         }

        /* --- New Club Details Modal Styling --- */
        #clubDetailsModal {
            position: fixed; inset: 0; background-color: rgba(31, 41, 55, 0.8);
            z-index: 150; display: flex; align-items: center; justify-content: center;
            padding: 1rem; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-out;
        }
        #clubDetailsModal.is-visible { opacity: 1; pointer-events: auto; }

        .details-modal-content {
             background-color: #ffffff;
             border-radius: 1rem;
             box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
             max-width: 90%; width: 640px;
             transform: translateY(20px) scale(0.98);
             transition: transform 0.3s ease-out, opacity 0.3s ease-out;
             opacity: 0;
             overflow: hidden;
             position: relative;
        }
         #clubDetailsModal.is-visible .details-modal-content { transform: translateY(0) scale(1); opacity: 1; }

         .details-header {
             background: linear-gradient(to right, #1f2937, #374151);
             padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center;
             position: relative; border-bottom: 4px solid #fb923c;
         }
         .details-header h3 { color: white; font-family: 'Orbitron', sans-serif; font-size: 1.5rem; margin-right: 40px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
         .details-close-btn { background: none; border: none; color: #d1d5db; transition: color 0.2s; cursor: pointer; }
         .details-close-btn:hover { color: white; }

        .details-body { padding: 1.5rem; background-color: #f9fafb; max-height: 70vh; overflow-y: auto; }
        .details-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 1rem; }

        .details-item { background-color: #ffffff; border-radius: 0.5rem; padding: 1rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .details-item h4 { 
            font-family: 'Tektur', sans-serif; font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; 
            text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; 
        }
        .details-item p, .details-item span { font-size: 1rem; color: #1f2937; font-weight: 600; word-wrap: break-word; }
        
        /* Specifics for the new layout */
        .details-logo-box { grid-column: span 2 / span 2; display: flex; align-items: center; justify-content: center; }
        .details-logo-box img { max-width: 100%; max-height: 120px; object-fit: contain; }
        
        .details-title-box { grid-column: span 4 / span 4; display: flex; flex-direction: column; justify-content: center; }
        .details-title-box h2 { font-family: 'Tektur', sans-serif; font-size: 1.75rem; font-weight: 600; color: #1f2937; line-height: 1.2; }
        .details-title-box .league-info { display: flex; align-items: center; margin-top: 0.5rem; }
        .details-title-box .league-logo { height: 24px; width: auto; margin-right: 0.5rem; }
        .details-title-box .league-name { font-size: 1rem; color: #4b5563; font-weight: 600; }
        
        .details-item.gc-2 { grid-column: span 2 / span 2; }
        .details-item.gc-3 { grid-column: span 3 / span 3; }
        .details-item.gc-4 { grid-column: span 4 / span 4; }
        .details-item.gc-6 { grid-column: span 6 / span 6; }
        
        .info-text { font-size: 0.9rem; color: #4b5563; font-weight: normal; line-height: 1.6; max-height: 150px; overflow-y: auto; padding-right: 0.5rem; }

        .details-loading { display: flex; justify-content: center; align-items: center; min-height: 250px; }
        .details-error { color: #dc2626; text-align: center; padding: 2rem; font-weight: 600; }

        .set-pick-button {
             display: inline-flex; align-items: center; justify-content: center; width: 100%;
             padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 700; 
             font-family: 'Tektur', sans-serif; font-size: 1rem; letter-spacing: 0.05em;
             transition: all 0.2s ease; cursor: pointer; border: 2px solid transparent;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
         .set-pick-button.selected {
             background-color: #fef9c3; color: #a16207; border-color: #facc15;
             box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
         }
         .set-pick-button.not-selected {
              background-color: #fb923c; color: white; border-color: #f97316;
         }
         .set-pick-button:hover:not(.selected) { background-color: #f97316; }
         .set-pick-button:hover.selected { background-color: #fef3c7; }
         .set-pick-button:active { transform: scale(0.98); }
         .set-pick-button svg { width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; }

         .club-stats-btn {
             /* Styles for your friend's button */
         }

    </style>
{% endblock meta %}

{% block content %}
    <main class="py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

            <header class="bg-white py-6 shadow-md mb-8 md:mb-12 rounded-lg border border-gray-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <h1 class="font-orbitron text-4xl md:text-5xl font-bold text-center text-gray-900 tracking-wider">
                        CLUB <span class="text-orange-500">DIRECTORY</span>
                    </h1>
                </div>
            </header>

            <section class="mb-12">
                <h2 class="text-3xl font-tektur font-bold text-center text-gray-900 mb-2">CHOOSE YOUR LEAGUE</h2>
                <p class="text-center text-gray-600 mb-6">Click a league marker on the map to see its clubs.</p>
                <div id="map" class="w-full rounded-xl shadow-lg border border-gray-300 bg-gray-200"></div>
            </section>

            
            {% if user.is_authenticated %}
                <!-- LOGGED-IN VERSION: The original, functional section -->
                <section id="champions-section" class="mb-12">
                    <h2 class="text-3xl font-tektur font-bold text-center text-gray-900 mb-6">MY LEAGUE PICKS</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto">
                        <!-- Slots will be populated by JS -->
                    </div>
                </section>
            
            {% else %}
                <!-- LOGGED-OUT VERSION: Blurred placeholder with a login prompt -->
                <section id="champions-section-logged-out" class="mb-12 relative">
                    <h2 class="text-3xl font-tektur font-bold text-center text-gray-900 mb-6">MY LEAGUE PICKS</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto filter blur-sm pointer-events-none">
                        <div class="champion-slot !cursor-default"><span class="select-text">SELECT PICK</span><span class="league-label">LEAGUE 1</span></div>
                        <div class="champion-slot !cursor-default"><span class="select-text">SELECT PICK</span><span class="league-label">LEAGUE 2</span></div>
                        <div class="champion-slot !cursor-default"><span class="select-text">SELECT PICK</span><span class="league-label">LEAGUE 3</span></div>
                    </div>
                    
                    <div class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100/50 backdrop-blur-[2px] rounded-lg">
                        <h3 class="font-tektur text-2xl font-bold text-gray-800 mb-4">Log in to Set Your Picks</h3>
                        <a href="{% url 'main:login' %}" 
                           class="px-6 py-2 bg-orange-500 text-white font-tektur rounded-full shadow-lg hover:bg-orange-600 transition-colors">
                            Log In
                        </a>
                    </div>
                </section>
            {% endif %}


            <div id="clubSelectorModal">
                <div class="modal-content">
                    <h3 id="modalLeagueTitle" class="font-tektur text-2xl font-bold text-gray-900 mb-2">Select Club for [League]</h3>
                    <p class="text-sm text-gray-600">Click a logo below to choose.</p>
                    <div class="logo-scroll-outer-container">
                        <div id="modalLogoScroll" class="logo-scroll-container">
                             </div>
                    </div>
                    <button id="closeModalBtn" class="mt-4 px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition-colors">Close</button>
                </div>
            </div>

             <div id="clubDetailsModal">
                <div class="details-modal-content">
                    <div class="details-header">
                        <h3 id="detailsClubName" class="font-orbitron text-2xl font-bold">Club Details</h3>
                        <div class="flex items-center space-x-4">
                            <button class="club-stats-btn bg-orange-500 hover:bg-orange-600 text-white font-tektur text-xs font-bold py-1 px-3 rounded-md shadow transition-colors duration-200">
                                Club Stats
                            </button>
                            <button id="detailsCloseBtn" class="details-close-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                    <div id="detailsContent" class="details-body">
                         <div class="details-loading p-8">
                            <svg class="animate-spin h-8 w-8 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                        </div>
                         <p id="detailsError" class="details-error hidden">Could not load club details.</p>
                        
                         <!-- ====================================================== -->
                         <!-- MODIFICATION: New Bento Grid Layout -->
                         <!-- ====================================================== -->
                        <div id="detailsBentoGrid" class="details-grid hidden">
                            
                            <!-- Header Info -->
                            <div class="details-item details-logo-box">
                                <img id="detailsLogo" src="" alt="Club Logo">
                            </div>
                            <div class="details-item details-title-box">
                                <h2 id="detailsClubNameModal">Club Name</h2>
                                <div class="league-info">
                                    <img id="detailsLeagueLogo" src="" alt="League Logo" class="league-logo">
                                    <p id="detailsLeagueName" class="league-name">League Name</p>
                                </div>
                            </div>
                            
                            <!-- Quick Info Row -->
                            <div class="details-item gc-2">
                                <h4>Founded</h4>
                                <p id="detailsFounded">----</p>
                            </div>
                            <div class="details-item gc-4">
                                <h4>Manager</h4>
                                <p id="detailsManager">N/A</p>
                            </div>

                            <!-- Stadium Info Row -->
                            <div class="details-item gc-4">
                                <h4>Stadium</h4>
                                <p id="detailsStadium">N/A</p>
                            </div>
                            <div class="details-item gc-2">
                                <h4>Capacity</h4>
                                <p id="detailsCapacity">N/A</p>
                            </div>

                            <!-- Text Info -->
                            <div class="details-item gc-6">
                                <h4>Description</h4>
                                <p id="detailsDescription" class="info-text">N/A</p>
                            </div>
                             <div class="details-item gc-6">
                                <h4>History Summary</h4>
                                <p id="detailsHistory" class="info-text">N/A</p>
                            </div>

                            <!-- Favorite Button -->
                            {% if user.is_authenticated %}
                                 <div class="details-item gc-6">
                                     <button id="setLeaguePickBtn" class="set-pick-button not-selected" data-club-id="" data-club-name="" data-logo-url="" data-league-id="">
                                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.518a.563.563 0 0 1 .32.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-3.357a.562.562 0 0 0-.652 0l-4.725 3.357a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .32-.988h5.518a.563.563 0 0 0 .475-.31L11.48 3.5Z" /></svg>
                                         <span id="setLeaguePickBtnText">Set as League Pick</span>
                                     </button>
                                </div>
                            {% endif %}
                        </div>
                        <!-- ============================================ -->
                        <!-- END MODIFICATION -->
                        <!-- ============================================ -->
                    </div>
                </div>
            </div>

            <section id="club-list-section">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 id="league-title" class="font-tektur text-4xl font-bold text-gray-900 text-center md:text-left order-2 md:order-1">All Clubs</h2>
                    <div class="relative w-full md:w-auto order-1 md:order-2">
                         <label for="searchBar" class="sr-only">Search</label>
                        <input type="text" id="searchBar" placeholder="Search this league..."
                               class="font-lato rounded-lg border-2 border-gray-300 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 shadow-sm transition-all duration-200 pl-10 pr-4 py-2 bg-white text-gray-900 w-full md:w-64 lg:w-80 outline-none">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /> </svg>
                        </div>
                    </div>
                </div>

                <div id="clubGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                     </div>
                 <p id="no-clubs-message" class="text-center text-gray-500 mt-8 hidden">No clubs found matching your search.</p>
            </section>
        </div>
    </main>

    {{ leagues_data|json_script:"leagues-data" }}

    <script>
        const rawLeagueData = JSON.parse(document.getElementById('leagues-data').textContent || '[]');
        const leagueData = rawLeagueData.sort((a, b) => a.name.localeCompare(b.name));
        let selectedChampions = JSON.parse(localStorage.getItem('selectedChampions') || '{}');

        const mapElement = document.getElementById('map');
        const clubGrid = document.getElementById('clubGrid');
        const leagueTitle = document.getElementById('league-title');
        const searchBar = document.getElementById('searchBar');
        const noClubsMessage = document.getElementById('no-clubs-message');
        
        const championsContainer = document.querySelector('#champions-section .grid'); 
        
        const modal = document.getElementById('clubSelectorModal');
        const modalLeagueTitle = document.getElementById('modalLeagueTitle');
        const modalLogoScroll = document.getElementById('modalLogoScroll');
        const closeModalBtn = document.getElementById('closeModalBtn');

        const detailsModal = document.getElementById('clubDetailsModal');
        const detailsCloseBtn = document.getElementById('detailsCloseBtn');
        const detailsClubName = document.getElementById('detailsClubName'); // Header
        const detailsContent = document.getElementById('detailsContent');
        const detailsLoading = detailsContent.querySelector('.details-loading');
        const detailsError = document.getElementById('detailsError');
        const detailsBentoGrid = document.getElementById('detailsBentoGrid');
        
        // --- New Bento Grid Elements ---
        const detailsLogo = document.getElementById('detailsLogo');
        const detailsClubNameModal = document.getElementById('detailsClubNameModal'); // Inside bento
        const detailsLeagueName = document.getElementById('detailsLeagueName');
        const detailsLeagueLogo = document.getElementById('detailsLeagueLogo');
        const detailsFounded = document.getElementById('detailsFounded');
        const detailsManager = document.getElementById('detailsManager');
        const detailsStadium = document.getElementById('detailsStadium');
        const detailsCapacity = document.getElementById('detailsCapacity');
        const detailsDescription = document.getElementById('detailsDescription');
        const detailsHistory = document.getElementById('detailsHistory');
        
        const setLeaguePickBtn = document.getElementById('setLeaguePickBtn');
        const setLeaguePickBtnText = document.getElementById('setLeaguePickBtnText');

        let allClubCards = [];
        let currentLeague = null;
        let leagueMapById = {};
        leagueData.forEach(l => leagueMapById[l.id] = l);
        let currentSelectingLeagueId = null;
        let scrollTimeout = null;
        let currentDetailClub = null;

        const map = L.map(mapElement).setView([48, 4], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
             attribution: '&copy; OpenStreetMap contributors &copy; CARTO', subdomains: 'abcd', maxZoom: 18
        }).addTo(map);

        function createClubCard(club, leagueName) {
            const initialsFallback = `https://placehold.co/100x100/EFEFEF/333333?text=${encodeURIComponent(club.name.substring(0,3).toUpperCase())}`;
            const logo = club.logo_url || initialsFallback;
            const onErrorScript = `if (this.src !== '${initialsFallback}') { this.src='${initialsFallback}'; this.onerror=null; }`;

            // Check favorite status directly from the club object
            const isFavorite = club.is_favorite || false;
            
            // ======================================================
            // MODIFICATION: Add Favorite Icon Toggle
            // ======================================================
            const heartIconHTML = `
                <button class="favorite-toggle-btn absolute top-3 right-3 p-1.5 rounded-full z-20 ${isFavorite ? 'bg-red-500 text-white' : 'bg-white/70 text-gray-700 backdrop-blur-sm'} transition-colors duration-200 hover:scale-110" 
                        data-club-id="${club.id}" 
                        data-is-favorite="${isFavorite}"
                        aria-label="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                      <path d="m11.645 20.91-1.091-1.091c-2.863-2.863-4.695-4.695-4.695-4.695C5.859 15.125 5 14.15 5 13c0-1.657 1.343-3 3-3 1.05 0 2.016.54 2.645 1.383C11.274 10.54 12.239 10 13.29 10c1.657 0 3 1.343 3 3 0 1.15-.859 2.125-1.855 3.124 0 0-1.832 1.832-4.695 4.695l-1.091 1.091a.5.5 0 0 1-.707 0Z" />
                    </svg>
                </button>
            `;
            // ============================================
            // END MODIFICATION
            // ============================================

            return `
                <div class="club-card bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 transition-all duration-300 hover:scale-105 hover:shadow-xl flex flex-col relative" data-league="${leagueName}" data-club-id="${club.id}">
                    
                    {% if user.is_authenticated %}
                        ${heartIconHTML}
                    {% endif %}

                    <img src="${logo}" alt="${club.name} Logo" class="w-20 h-20 mx-auto mt-5 object-contain" onerror="${onErrorScript}">
                    <div class="p-5 flex flex-col flex-grow">
                        <h2 class="club-name font-tektur text-xl font-bold text-gray-900 text-center truncate" title="${club.name}">${club.name}</h2>
                        <span class="bg-orange-500 text-white text-xs font-bold uppercase rounded-full px-3 py-1 self-center my-3 font-lato">${leagueName}</span>
                        <p class="font-lato text-gray-600 text-sm text-center flex-grow mb-4">${club.desc}</p>
                        <div class="mt-auto flex items-center justify-center space-x-3">
                            <button class="view-club-btn bg-gradient-to-r from-orange-500 to-orange-400 text-white font-tektur text-sm font-bold py-2 px-4 rounded-full shadow-md hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5 active:scale-95 text-center">VIEW DETAILS</button>
                        </div>
                    </div>
                </div>`;
        }
        
        function showAllClubs() {
             currentLeague = null;
             clubGrid.innerHTML = '';
             leagueTitle.textContent = "All Clubs";
             allClubCards = [];
             noClubsMessage.classList.add('hidden');

             if (!leagueData || leagueData.length === 0) {
                  clubGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">No clubs available.</p>';
                  return;
             }

             let clubCount = 0;
             leagueData.forEach(league => {
                 if (league.clubs && league.clubs.length > 0) {
                     league.clubs.forEach(club => {
                        const cardHTML = createClubCard(club, league.name);
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = cardHTML.trim();
                        const cardElement = tempDiv.firstElementChild;
                        if (cardElement instanceof HTMLElement) {
                            clubGrid.appendChild(cardElement);
                            allClubCards.push(cardElement);
                            clubCount++;
                        }
                    });
                 }
             });
             
             if (clubCount === 0) {
                 clubGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">No clubs found in any league.</p>';
             }

             searchBar.value = '';
             filterClubs();
        }

        function showClubs(league) {
             currentLeague = league;
             clubGrid.innerHTML = '';
             leagueTitle.textContent = league.name;
             allClubCards = [];
             noClubsMessage.classList.add('hidden');

             if (!league || !league.clubs || league.clubs.length === 0) {
                  clubGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">No clubs available for this league.</p>';
                  return;
             }

             league.clubs.forEach(club => {
                const cardHTML = createClubCard(club, league.name);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML.trim();
                const cardElement = tempDiv.firstElementChild;
                if (cardElement instanceof HTMLElement) {
                    clubGrid.appendChild(cardElement);
                    allClubCards.push(cardElement);
                }
            });
            searchBar.value = '';
            filterClubs();
        }

        function filterClubs() {
            const searchTerm = searchBar.value.toLowerCase().trim();
            let visibleCount = 0;
            allClubCards.forEach(card => {
                if (!(card instanceof HTMLElement)) return;
                const cardNameElement = card.querySelector('h2.club-name');
                if (!cardNameElement) return;
                const cardName = cardNameElement.textContent.toLowerCase();
                const nameMatch = cardName.includes(searchTerm);
                card.classList.toggle('hidden', !nameMatch);
                card.classList.toggle('flex', nameMatch);
                if(nameMatch) visibleCount++;
            });
            noClubsMessage.classList.toggle('hidden', visibleCount > 0 || allClubCards.length === 0);
        }

        function createChampionSlotHTML(league) {
            const champion = selectedChampions[league.id];
            let contentHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mb-2"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /> </svg>
                <span class="select-text">SELECT ${league.short_id || 'PICK'}</span>`;

            if (champion) {
                 const initialsFallback = `https://placehold.co/64x64/EFEFEF/333333?text=${encodeURIComponent(champion.clubName.substring(0,3).toUpperCase())}`;
                 const logo = champion.logoUrl || initialsFallback;
                 const onErrorScript = `if (this.src !== '${initialsFallback}') { this.src='${initialsFallback}'; this.onerror=null; }`;
                 contentHTML = `
                     <img src="${logo}" alt="${champion.clubName}" class="selected-logo" onerror="${onErrorScript}">
                     <span class="selected-club-name">${champion.clubName}</span>`;
            }

            return `
                <div id="champion-slot-${league.id}" class="champion-slot" data-league-id="${league.id}">
                    ${contentHTML}
                    <span class="league-label">${league.name}</span>
                </div>`;
        }

        function updateChampionSlotDisplay(leagueId) {
            const slotElement = document.getElementById(`champion-slot-${leagueId}`);
            if (!slotElement) return;

            const league = leagueMapById[leagueId];
            if (!league) return;

            const champion = selectedChampions[leagueId];
            let contentHTML = `
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mb-2"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /> </svg>
                 <span class="select-text">SELECT ${league.short_id || 'PICK'}</span>`;

            if (champion) {
                 const initialsFallback = `https://placehold.co/64x64/EFEFEF/333333?text=${encodeURIComponent(champion.clubName.substring(0,3).toUpperCase())}`;
                 const logo = champion.logoUrl || initialsFallback;
                 const onErrorScript = `if (this.src !== '${initialsFallback}') { this.src='${initialsFallback}'; this.onerror=null; }`;
                 contentHTML = `
                     <img src="${logo}" alt="${champion.clubName}" class="selected-logo" onerror="${onErrorScript}">
                     <span class="selected-club-name">${champion.clubName}</span>`;
            }
            const leagueLabelHTML = `<span class="league-label">${league.name}</span>`;
            slotElement.innerHTML = contentHTML + leagueLabelHTML;
        }

        function populateChampionSlots() {
            if (!championsContainer) return;
            championsContainer.innerHTML = '';
            const topLeagues = leagueData.slice(0, 6);
            topLeagues.forEach(league => {
                championsContainer.innerHTML += createChampionSlotHTML(league);
            });
        }

         function handleModalScroll() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                highlightCenterItem();
            }, 100);
        }

        function highlightCenterItem() {
            const container = modalLogoScroll;
            if (!container) return;
            const containerRect = container.getBoundingClientRect();
            const containerCenter = containerRect.left + containerRect.width / 2;

            let closestItem = null;
            let minDistance = Infinity;

            const items = container.querySelectorAll('img.modal-logo-item, div.none-option');
            items.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                const itemCenter = itemRect.left + itemRect.width / 2;
                const distance = Math.abs(containerCenter - itemCenter);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestItem = item;
                }
                item.classList.remove('is-center');
                const tooltipAnchor = item.closest('.tooltip-anchor, .none-option-container');
            });

            if (closestItem) {
                closestItem.classList.add('is-center');
                const tooltipAnchor = closestItem.closest('.tooltip-anchor, .none-option-container');
            }
        }

        function openClubSelector(leagueId) {
            const league = leagueMapById[leagueId];
            if (!league) return;

            currentSelectingLeagueId = leagueId;
            modalLeagueTitle.textContent = `Select Pick for ${league.name}`;
            modalLogoScroll.innerHTML = '';

            const noneOptionContainer = document.createElement('div');
            noneOptionContainer.classList.add('none-option-container');
            noneOptionContainer.setAttribute('data-tooltip', 'Clear Selection');
            noneOptionContainer.innerHTML = `
                <div class="none-option modal-logo-item" data-club-id="NONE">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" /> </svg>
                </div>`;
            modalLogoScroll.appendChild(noneOptionContainer);

            if (!league.clubs || league.clubs.length === 0) {
                 setTimeout(highlightCenterItem, 50);
            } else {
                league.clubs.forEach(club => {
                    const initialsFallback = `https://placehold.co/60x60/EFEFEF/333333?text=${encodeURIComponent(club.name.substring(0,3).toUpperCase())}`;
                    const logo = club.logo_url || initialsFallback;
                    const onErrorScript = `if (this.src !== '${initialsFallback}') { this.src='${initialsFallback}'; this.onerror=null; }`;

                    const imgContainer = document.createElement('div');
                    imgContainer.classList.add('tooltip-anchor');
                    imgContainer.setAttribute('data-tooltip', club.name);
                    imgContainer.innerHTML = `
                        <img src="${logo}"
                             alt="${club.name}"
                             class="modal-logo-item"
                             data-club-id="${club.id}"
                             data-club-name="${club.name}"
                             data-logo-url="${club.logo_url || ''}"
                             onerror="${onErrorScript}">`;
                    modalLogoScroll.appendChild(imgContainer);
                });

                 const currentlySelected = selectedChampions[currentSelectingLeagueId];
                 let targetElement = noneOptionContainer.querySelector('.none-option');
                 if (currentlySelected) {
                     const selectedImg = modalLogoScroll.querySelector(`img[data-club-id="${currentlySelected.clubId}"]`);
                     if (selectedImg) {
                         targetElement = selectedImg;
                     }
                 }
                 if(targetElement) {
                     setTimeout(() => scrollToItem(targetElement), 50);
                 } else {
                      setTimeout(highlightCenterItem, 50);
                 }

            }
            modalLogoScroll.removeEventListener('scroll', handleModalScroll);
            modalLogoScroll.addEventListener('scroll', handleModalScroll);
            modal.classList.add('is-visible');
        }

        function closeClubSelector() {
            modalLogoScroll.removeEventListener('scroll', handleModalScroll);
            modal.classList.remove('is-visible');
            currentSelectingLeagueId = null;
        }

        function selectChampion(leagueId, clubId, clubName, logoUrl) {
             if (!leagueId) return;

             if (clubId === 'NONE' || clubId === null) {
                 delete selectedChampions[leagueId];
             } else {
                 selectedChampions[leagueId] = { clubId, clubName, logoUrl: logoUrl || null };
             }

            localStorage.setItem('selectedChampions', JSON.stringify(selectedChampions));
            updateChampionSlotDisplay(leagueId);
            updatePickButtonState(leagueId);
            if (currentSelectingLeagueId === leagueId) {
                closeClubSelector();
            }
        }

        function scrollToItem(itemElement) {
             if (!itemElement) return;
             itemElement.scrollIntoView({
                 behavior: 'smooth',
                 block: 'nearest',
                 inline: 'center'
             });
             setTimeout(() => highlightCenterItem(), 50);
        }

        // --- Club Details Modal Functions ---
        function showDetailsModal() {
            detailsModal.classList.add('is-visible');
        }
        function hideDetailsModal() {
             detailsModal.classList.remove('is-visible');
             currentDetailClub = null;
        }

        function updatePickButtonState(leagueId = null) {
            if (!setLeaguePickBtn) return;
            
            if (!currentDetailClub || (leagueId && currentDetailClub.league_id !== leagueId)) {
                return;
            }
            const currentPick = selectedChampions[currentDetailClub.league_id];
            const isSelected = currentPick && currentPick.clubId === currentDetailClub.id;

            if (isSelected) {
                setLeaguePickBtnText.textContent = 'Selected as League Pick';
                setLeaguePickBtn.classList.remove('not-selected');
                setLeaguePickBtn.classList.add('selected');
            } else {
                setLeaguePickBtnText.textContent = 'Set as League Pick';
                setLeaguePickBtn.classList.add('not-selected');
                setLeaguePickBtn.classList.remove('selected');
            }
            setLeaguePickBtn.dataset.clubId = currentDetailClub.id;
            setLeaguePickBtn.dataset.clubName = currentDetailClub.name;
            setLeaguePickBtn.dataset.logoUrl = currentDetailClub.logo_url || '';
            setLeaguePickBtn.dataset.leagueId = currentDetailClub.league_id;
            setLeaguePickBtn.dataset.isSelected = isSelected;
        }

        async function fetchAndShowClubDetails(clubId) {
             showDetailsModal();
             detailsLoading.classList.remove('hidden');
             detailsBentoGrid.classList.add('hidden');
             detailsError.classList.add('hidden');
             detailsClubName.textContent = 'Loading...';
             currentDetailClub = null;

             const url = `/directory/club/${clubId}/`;

             try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                currentDetailClub = data;

                // --- Populate Bento Grid ---
                detailsClubName.textContent = data.name || 'Club Details'; // Header
                detailsClubNameModal.textContent = data.name || 'Club Name'; // Bento
                
                const initialsFallback = `https://placehold.co/100x100/EFEFEF/333333?text=${encodeURIComponent((data.name || '?').substring(0,3).toUpperCase())}`;
                detailsLogo.src = data.logo_url || initialsFallback;
                detailsLogo.alt = `${data.name || 'Club'} Logo`;
                detailsLogo.onerror = function() { if (this.src !== initialsFallback) { this.src=initialsFallback; this.onerror=null; }};

                detailsLeagueName.textContent = data.league_name || 'N/A';
                const leagueLogoPath = data.league_logo_path ? `{% static '' %}${data.league_logo_path.replace(/\\/g, '/')}` : '';
                const leagueLogoFallback = `https://placehold.co/40x24/CCCCCC/333333?text=L`;
                detailsLeagueLogo.src = leagueLogoPath || leagueLogoFallback;
                detailsLeagueLogo.alt = `${data.league_name || 'League'} Logo`;
                detailsLeagueLogo.onerror = function() { if (this.src !== leagueLogoFallback) { this.src=leagueLogoFallback; this.onerror=null; }};
                detailsLeagueLogo.classList.toggle('hidden', !leagueLogoPath && !data.league_name);

                detailsFounded.textContent = data.founded_year || '----';
                detailsManager.textContent = data.manager_name || 'N/A';
                detailsStadium.textContent = data.stadium_name || 'N/A';
                detailsCapacity.textContent = data.stadium_capacity_str || 'N/A';
                detailsDescription.textContent = data.description || 'No description available.';
                detailsHistory.textContent = data.history_summary || 'No history summary available.';

                if (setLeaguePickBtn) {
                    updatePickButtonState();
                }
                
                detailsLoading.classList.add('hidden');
                detailsBentoGrid.classList.remove('hidden');

             } catch (error) {
                 console.error("Error fetching club details:", error);
                 detailsLoading.classList.add('hidden');
                 detailsError.classList.remove('hidden');
                 detailsClubName.textContent = 'Error Loading Details';
             }
        }

        // ======================================================
        // NEW FUNCTION: handleFavoriteClick
        // ======================================================
        async function handleFavoriteClick(e) {
            e.preventDefault();
            e.stopPropagation(); // Stop it from triggering other clicks

            const button = e.currentTarget;
            const clubId = button.dataset.clubId;
            let isFavorite = button.dataset.isFavorite === 'true';

            // Optimistic UI update
            isFavorite = !isFavorite;
            updateFavoriteButtonUI(button, isFavorite);

            const url = `/directory/toggle-favorite/`;
            const csrftoken = getCookie('csrftoken');
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `club_id=${clubId}`
                });

                if (!response.ok) {
                    throw new Error('Server response was not ok.');
                }
                
                const data = await response.json();
                
                // Server returns the true state, re-sync UI
                updateFavoriteButtonUI(button, data.is_favorite);

                // Update the master data object
                updateClubFavoriteStatus(clubId, data.is_favorite);

            } catch (error) {
                console.error("Error toggling favorite:", error);
                // Revert optimistic update on error
                updateFavoriteButtonUI(button, !isFavorite); 
            }
        }
        
        function updateFavoriteButtonUI(button, isFavorite) {
            button.dataset.isFavorite = isFavorite;
            button.setAttribute('aria-label', isFavorite ? 'Remove from favorites' : 'Add to favorites');
            if (isFavorite) {
                button.classList.add('bg-red-500', 'text-white');
                button.classList.remove('bg-white/70', 'text-gray-700');
            } else {
                button.classList.remove('bg-red-500', 'text-white');
                button.classList.add('bg-white/70', 'text-gray-700');
            }
        }
        
        function updateClubFavoriteStatus(clubId, isFavorite) {
            // Update the source of truth
             for (const league of leagueData) {
                const club = league.clubs.find(c => c.id == clubId);
                if (club) {
                    club.is_favorite = isFavorite;
                    break;
                }
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        // ============================================
        // END NEW FUNCTIONS
        // ============================================


        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            
            if (championsContainer) {
                populateChampionSlots();
                
                championsContainer.addEventListener('click', (e) => {
                    const slot = e.target.closest('.champion-slot');
                    if (slot) {
                        const leagueId = slot.dataset.leagueId;
                        if(leagueId) openClubSelector(leagueId);
                    }
                });
                
                closeModalBtn.addEventListener('click', closeClubSelector);

                modalLogoScroll.addEventListener('click', (e) => {
                     const clickedItem = e.target.closest('img.modal-logo-item, div.none-option');
                     if (clickedItem) {
                         if (clickedItem.classList.contains('is-center')) {
                             if (clickedItem.classList.contains('none-option')) {
                                 selectChampion(currentSelectingLeagueId, 'NONE', null, null);
                             } else {
                                 const clubId = clickedItem.dataset.clubId;
                                 const clubName = clickedItem.dataset.clubName;
                                 const logoUrl = clickedItem.dataset.logoUrl;
                                 if(clubId && clubName) selectChampion(currentSelectingLeagueId, clubId, clubName, logoUrl);
                             }
                         } else {
                             scrollToItem(clickedItem);
                         }
                     }
                });
                modal.addEventListener('click', (e) => { if (e.target === modal) closeClubSelector(); });
            }


            leagueData.forEach(league => {
                 const logoStaticPath = league.logo_path ? `{% static '' %}${league.logo_path.replace(/\\/g, '/')}` : `https://placehold.co/48x48/CCCCCC/333333?text=${league.short_id || 'L'}`;
                 const mapMarkerFallbackUrl = `https://placehold.co/48x48/CCCCCC/333333?text=${league.short_id || 'L'}`;

                const leagueIcon = L.divIcon({
                    className: '',
                     html: `<div class="league-icon-div" title="${league.name}" style="background-image: url('${logoStaticPath}');"
                                onerror="this.style.backgroundImage='url(${mapMarkerFallbackUrl})'; this.onerror=null;">
                            </div>`,
                    iconSize: [52, 52],
                    iconAnchor: [26, 26]
                });

                L.marker(league.coords, { icon: leagueIcon }).addTo(map)
                    .on('click', () => {
                        showClubs(league);
                        map.setView(league.coords, 6);
                    })
                    .bindTooltip(league.name, {
                        permanent: false, direction: 'top', offset: [0, -26],
                        className: 'league-tooltip'
                    });
            });

            searchBar.addEventListener('input', filterClubs);

            clubGrid.addEventListener('click', (e) => {
                 const viewButton = e.target.closest('button.view-club-btn');
                 const favButton = e.target.closest('button.favorite-toggle-btn');

                 if (favButton) {
                     handleFavoriteClick(e);
                     return;
                 }
                 
                 if (viewButton) {
                     e.preventDefault();
                     const card = viewButton.closest('.club-card');
                     if (card) {
                         const clubId = card.dataset.clubId;
                         if (clubId) {
                             fetchAndShowClubDetails(clubId);
                         } else {
                              console.error("Could not find club ID on card.");
                         }
                     }
                 }
            });

             detailsCloseBtn.addEventListener('click', hideDetailsModal);
             detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) hideDetailsModal(); });

            
             if (setLeaguePickBtn) {
                 setLeaguePickBtn.addEventListener('click', () => {
                     const clubId = setLeaguePickBtn.dataset.clubId;
                     const clubName = setLeaguePickBtn.dataset.clubName;
                     const logoUrl = setLeaguePickBtn.dataset.logoUrl;
                     const leagueId = setLeaguePickBtn.dataset.leagueId;
                     const isSelected = setLeaguePickBtn.dataset.isSelected === 'true';

                     if (leagueId && clubId && clubName) {
                         selectChampion(leagueId, isSelected ? 'NONE' : clubId, isSelected ? null : clubName, isSelected ? null : logoUrl);
                     } else {
                          console.error("Missing data on pick button to set/unset champion.");
                     }
                 });
             }


            if (leagueData && leagueData.length > 0) {
                showAllClubs();
            } else {
                leagueTitle.textContent = "No Leagues Available";
                clubGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Could not load club data.</p>';
                noClubsMessage.classList.remove('hidden');
            }
        });

    </script>
{% endblock content %}