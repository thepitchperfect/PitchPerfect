{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - Forum{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'forum/css/forum.css' %}">
<link rel="stylesheet" href="{% static 'forum/css/forum-detail.css' %}">
{% endblock %}

{% block content %}
<div class="forum-detail">
    <!-- Back Button -->
    <a href="{% url 'forum:forum_home' %}" class="back-button">‚Üê Back to Forum</a>

    <!-- Post Content -->
    <article class="post-card margin-bottom 4" >
        <header class="post-header">
            <div class="post-meta">
                <span class="post-type-badge {% if post.is_official_news %}news{% else %}discussion{% endif %}">
                    {{ post.get_post_type_display }}
                </span>
                <h1 class="post-title">{{ post.title }}</h1>
            </div>

            <div class="post-info">
                <span class="author">{{ post.author.username }} | </span>
                <span class="date">{{ post.created_at|date:"F j, Y g:i A" }}</span>
            </div>

            <!-- Club Tags -->
            {% if post.clubs.exists %}
            <div class="club-tags">
                {% for club in post.clubs.all %}
                <span class="club-tag">{{ club.name }}</span>
                {% endfor %}
            </div>
            {% endif %}

            {% if user == post.author or user.is_staff %}
            <div class="post-actions" style="position: absolute; top: 1em; right: 1em;">
                <a href="#" onclick="openEditModal({{ post.id }})" class="font-lato">Edit | </a>
                <a href="#" onclick="deletePost({{ post.id }})" class="delete-link">Delete</a>
            </div>
            {% endif %}
        </header>

        <!-- Post Body -->
        <div class="post-content">
            {{ post.content|linebreaks }}
        </div>

        <!-- Post Images -->
        {% if post.images.exists %}
        <div class="post-images">
            {% for image in post.images.all %}
            <figure class="image-container">
                <img src="{{ image.image_url }}" alt="{{ image.caption|default:post.title }}" loading="lazy">
                {% if image.caption %}
                <figcaption>{{ image.caption }}</figcaption>
                {% endif %}
            </figure>
            {% endfor %}
        </div>
        {% endif %}
    </article>

    <!-- Comments Section -->
    <section class="comments-card">
        <h2 class="comments-title">Comments ({{ comments|length }})</h2>

        {% if user.is_authenticated %}
        <!-- Comment Form -->
        <form id="commentForm" class="comment-form" data-post-id="{{ post.id }}">
            <div class="form-group">
                <textarea 
                    name="content" 
                    id="commentContent" 
                    rows="2" 
                    placeholder="Share your thoughts..."
                    required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
        {% else %}
        <div class="login-prompt">
            <p>Please <a href="{% url 'login' %}">log in</a> to post comments.</p>
        </div>
        {% endif %}

        <!-- Comments List -->
        <div class="comments-list" id="commentsList">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-header">
                    <span class="comment-author">üë§ {{ comment.author.username }}</span>
                    <span class="comment-date">{{ comment.created_at|date:"F j, Y g:i A" }}</span>
                </div>
                <div class="comment-content">
                    {{ comment.content|linebreaks }}
                </div>
            </div>
            {% empty %}
            <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
            {% endfor %}
        </div>
    </section>
</div>

<!-- Create/Edit Post Modal -->
<div id="postModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Create Post</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        
        <form id="postForm">
            {% if user.is_staff %}
            <div class="form-group">
                <label>Post Type:</label>
                <select id="postType">
                    <option value="discussion">üí¨ Discussion</option>
                    <option value="news">üì∞ Official News</option>
                </select>
            </div>
            {% endif %}

            <div class="form-group">
                <label>Title:</label>
                <input type="text" id="postTitle" required placeholder="Enter post title">
            </div>

            <div class="form-group">
                <label>Content:</label>
                <textarea id="postContent" required placeholder="Share your thoughts..."></textarea>
            </div>

            <div class="form-group">
                <label>Tag Clubs (up to 3):</label>
                <div id="dynamicClubFields"></div>
                <small>You can tag up to 3 clubs. Remove a tag to add another.</small>
            </div>

            <div class="form-group">
                <label>Image URLs (optional):</label>
                <div class="image-inputs" id="imagesContainer">
                    <div class="image-input">
                        <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                        <input type="text" class="image-caption" placeholder="Caption">
                        <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addImageInput()" style="margin-top: 0.5rem;">
                    + Add Image
                </button>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>
</div>

<!-- Success Toast -->
<div id="successToast" class="toast success hidden">
    <span class="toast-icon">‚úì</span>
    <span class="toast-message"></span>
</div>

<!-- Error Toast -->
<div id="errorToast" class="toast error hidden">
    <span class="toast-icon">‚ö†</span>
    <span class="toast-message"></span>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const content = document.getElementById('commentContent').value;
            const postId = this.dataset.postId;
            
            try {
                const response = await fetch(`/forum/api/post/${postId}/comment/create/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ content })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const commentsList = document.getElementById('commentsList');
                    const noCommentsMsg = commentsList.querySelector('.no-comments');
                    if (noCommentsMsg) noCommentsMsg.remove();
                    
                    const newComment = document.createElement('div');
                    newComment.className = 'comment';
                    newComment.innerHTML = `
                        <div class="comment-header">
                            <span class="comment-author">üë§ ${data.comment.author}</span>
                            <span class="comment-date">${data.comment.created_at}</span>
                        </div>
                        <div class="comment-content">
                            ${data.comment.content.replace(/\n/g, '<br>')}
                        </div>
                    `;
                    commentsList.insertBefore(newComment, commentsList.firstChild);
                    document.getElementById('commentContent').value = '';
                    showToast('success', 'Comment posted successfully!');
                } else {
                    showToast('error', data.error || 'Failed to post comment');
                }
            } catch (error) {
                showToast('error', 'An error occurred. Please try again.');
            }
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function showToast(type, message) {
        const toast = document.getElementById(`${type}Toast`);
        const messageElement = toast.querySelector('.toast-message');
        messageElement.textContent = message;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }
});


    const csrftoken = getCookie('csrftoken');
    let editingPostId = null;

    // --- Dynamic club tagging (max 3) ---
    const clubs = [
        {% for club in clubs %}
        {id: '{{ club.id }}', name: '{{ club.name }}', league: '{{ club.league.name }}'},
        {% endfor %}
    ];
    const dynamicClubFields = document.getElementById('dynamicClubFields');
    let clubTags = [];

    function renderClubFields() {
        dynamicClubFields.innerHTML = '';
        // Render tags
        clubTags.forEach((club, idx) => {
            const tag = document.createElement('span');
            tag.className = 'dynamic-club-tag';
            tag.dataset.id = club.id;
            tag.appendChild(document.createTextNode(club.name + ' - ' + club.league));
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '√ó';
            removeBtn.className = 'remove-club-btn';
            removeBtn.onclick = function() {
                clubTags = clubTags.filter((_, i) => i !== idx);
                renderClubFields();
            };
            tag.appendChild(removeBtn);
            dynamicClubFields.appendChild(tag);
        });
        // Render new input if less than 3
        if (clubTags.length < 3) {
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Type to search clubs...';
            input.setAttribute('list', 'clubsDatalist');
            input.className = 'club-search-input';
            input.autocomplete = 'off';
            input.addEventListener('change', function(e) {
                const val = input.value.trim();
                if (!val) return;
                const match = clubs.find(c => (c.name + ' - ' + c.league) === val);
                if (match && !clubTags.some(t => t.id === match.id)) {
                    clubTags.push(match);
                    renderClubFields();
                }
                input.value = '';
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.dispatchEvent(new Event('change'));
                }
            });
            dynamicClubFields.appendChild(input);
        }
    }
    // Datalist for club search
    if (!document.getElementById('clubsDatalist')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'clubsDatalist';
        clubs.forEach(club => {
            const opt = document.createElement('option');
            opt.value = club.name + ' - ' + club.league;
            opt.dataset.id = club.id;
            datalist.appendChild(opt);
        });
        document.body.appendChild(datalist);
    }
    renderClubFields();

    // For edit: prepopulate clubTags if editing
    window.prefillClubTags = function(ids) {
        clubTags = clubs.filter(c => ids.includes(c.id));
        renderClubFields();
    }

    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Create Post';
        document.getElementById('postForm').reset();
        editingPostId = null;
        document.getElementById('imagesContainer').innerHTML = `
            <div class="image-input">
                <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                <input type="text" class="image-caption" placeholder="Caption">
                <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
            </div>
        `;
        document.getElementById('postModal').style.display = 'block';
        renderClubFields();
    }

    function openEditModal(postId) {
        editingPostId = postId;
        document.getElementById('modalTitle').textContent = 'Edit Post';
        fetch(`/forum/api/post/${postId}/data/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const post = data.post;
                document.getElementById('postTitle').value = post.title;
                document.getElementById('postContent').value = post.content;
                var isStaff = "{{ user.is_staff|yesno:'true,false' }}" === "true";
                if (isStaff && document.getElementById('postType')) {
                    document.getElementById('postType').value = post.post_type;
                }
                // Populate images
                const imagesContainer = document.getElementById('imagesContainer');
                imagesContainer.innerHTML = '';
                if (post.images && post.images.length > 0) {
                    post.images.forEach(img => {
                        const div = document.createElement('div');
                        div.className = 'image-input';
                        div.innerHTML = `
                            <input type="url" class="image-url" placeholder="https://example.com/image.jpg" value="${img.url}">
                            <input type="text" class="image-caption" placeholder="Caption" value="${img.caption || ''}">
                            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)">Remove Image</button>
                        `;
                        imagesContainer.appendChild(div);
                    });
                } else {
                    imagesContainer.innerHTML = `
                        <div class="image-input">
                            <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                            <input type="text" class="image-caption" placeholder="Caption">
                            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
                        </div>
                    `;
                }
                document.getElementById('postModal').style.display = 'block';
                prefillClubTags(post.club_ids);
                renderClubFields();
            } else {
                alert(data.error || 'Failed to load post data');
            }
        })
        .catch(error => {
            alert('Failed to load post data: ' + error.message);
        });
    }

    function closeModal() {
        document.getElementById('postModal').style.display = 'none';
    }

    function addImageInput() {
        const container = document.getElementById('imagesContainer');
        const div = document.createElement('div');
        div.className = 'image-input';
        div.innerHTML = `
            <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
            <input type="text" class="image-caption" placeholder="Caption">
            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)">Remove Image</button>
        `;
        container.appendChild(div);
    }

    function removeImageInput(btn) {
        btn.closest('.image-input').remove();
    }

    document.getElementById('postForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const images = [];
        document.querySelectorAll('.image-input').forEach(input => {
            const url = input.querySelector('.image-url').value;
            const caption = input.querySelector('.image-caption').value;
            if (url) images.push({ url, caption });
        });
        const selectedClubs = Array.from(document.querySelectorAll('.dynamic-club-tag'))
            .map(el => el.dataset.id);
        const data = {
            title: document.getElementById('postTitle').value,
            content: document.getElementById('postContent').value,
            club_ids: selectedClubs,
            league_id: document.getElementById('postLeague') ? document.getElementById('postLeague').value : null,
            images: images
        };
        var isStaff = "{{ user.is_staff|yesno:'true,false' }}" === "true";
        if (isStaff) {
            data.post_type = document.getElementById('postType').value;
        }
        const url = editingPostId 
            ? `/forum/api/post/${editingPostId}/update/`
            : '/forum/api/post/create/';
        const method = editingPostId ? 'PUT' : 'POST';
        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                alert(editingPostId ? 'Post updated!' : 'Post created!');
                closeModal();
                setTimeout(() => location.reload(), 1000);
            } else {
                alert(result.error || 'An error occurred');
            }
        } catch (error) {
            alert('An error occurred');
        }
    });

    async function deletePost(id) {
        if (!confirm('Are you sure you want to delete this post?')) return;
        
        try {
            const response = await fetch(`/forum/api/post/${id}/delete/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Post deleted!', 'success');
                document.getElementById(`post-${id}`).remove();
            } else {
                showAlert(result.error || 'An error occurred', 'error');
            }
        } catch (error) {
            showAlert('An error occurred', 'error');
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('postModal');
        if (event.target == modal) closeModal();
    }

</script>
{% endblock %}
{% endblock content %}
