{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - Forum{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'forum/css/forum_detail.css' %}">
{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="detail-container">
    <a href="{% url 'forum:forum_home' %}" class="back-link">
        ← Back to Forum
    </a>

    <!-- DEBUG: Show if user is staff -->
    <div style="color:red; font-weight:bold;">is_staff: {{ user.is_staff }}</div>
    
    <article class="post-detail {% if post.is_official_news %}official-news{% endif %}">
        <!-- Image Section with Navigation -->
        <div class="post-image-section">
            
            {% if post.images.all %}
                <img id="mainImage" 
                     src="{{ post.images.first.image_url }}" 
                     alt="{{ post.title }}" 
                     class="post-main-image">
                
                {% if post.images.count > 1 %}
                <div class="image-navigation">
                    <button class="image-nav-btn" id="prevImageBtn" onclick="changeImage(-1)">‹</button>
                    <span class="image-counter">
                        <span id="currentImageIndex">1</span> / {{ post.images.count }}
                    </span>
                    <button class="image-nav-btn" id="nextImageBtn" onclick="changeImage(1)">›</button>
                </div>
                {% endif %}
            {% else %}
                <div class="no-image-placeholder">
                    {{ post.title|truncatewords:5 }}
                </div>
            {% endif %}
        </div>
        
        <!-- Content Section -->
        <div class="post-content-section">
            <div class="post-header">
                <div class="post-title-row">
                    <h1 class="post-title">{{ post.title }}</h1>
                    
                    {% if user == post.author or user.is_staff %}
                    <div class="post-actions">
                        {% if user == post.author %}
                            <a href="#" onclick="openEditModal({{ post.id }})" class="font-lato">Edit | </a>
                        {% endif %}
                        {% if user == post.author or user.is_staff %}
                            <a href="#" onclick="deletePost({{ post.id }})" class="delete-link">Delete</a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="post-meta">
                    <span class="post-meta-item">
                        <strong>{{ post.author.username }}</strong>
                    </span>
                    <span class="post-meta-item">
                        {% if post.updated_at > post.created_at %}
                        {{ post.updated_at|date:"F d, Y H:i" }} • <em>Edited</em>
                        {% else %}
                        {{ post.created_at|date:"F d, Y H:i" }}
                        {% endif %}
                    </span>
                    <span class="post-meta-item">
                        {{ comments.count }} comment{{ comments.count|pluralize }}
                    </span>
                </div>
                
                {% if post.clubs.all %}
                <div class="post-clubs">
                    {% for club in post.clubs.all %}
                    <span class="club-badge">
                        {% if club.logo_url %}
                        <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo">
                        {% endif %}
                        {{ club.name }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="post-body">{{ post.content }}</div>
        </div>
    </article>
    
    <!-- Comments Section -->
    <section class="comments-section">
        <h2 class="comments-title">Comments ({{ comments.count }})</h2>
        
        {% if user.is_authenticated %}
        <div class="comment-form">
            <h3 class="comment-form-title">Add Your Comment</h3>
            <form id="commentForm">
                <textarea id="commentContent" 
                          class="comment-textarea" 
                          placeholder="Share your thoughts..." 
                          required></textarea>
                <div class="comment-form-actions">
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </div>
            </form>
        </div>
        {% else %}
        <div class="login-prompt">
            <p><a href="{% url 'login' %}">Login</a> to join the discussion</p>
        </div>
        {% endif %}
        
        <div id="commentsContainer">
            {% if comments %}
                {% for comment in comments %}
                <div class="comment" id="comment-{{ comment.id }}">
                    <div class="comment-top">
                        <div class="comment-author">
                            <div class="comment-avatar">{{ comment.author.username|first|upper }}</div>
                            <div>
                                <div class="comment-author-name">{{ comment.author.username }}</div>
                                <div class="comment-date">
                                    {% if comment.updated_at > comment.created_at %}
                                    {{ comment.updated_at|date:"M d, Y H:i" }} • Edited
                                    {% else %}
                                    {{ comment.created_at|date:"M d, Y H:i" }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {% if user == comment.author or user.is_staff %}
                        <div class="comment-actions">
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="editComment({{ comment.id }})"></button>
                            <button class="btn btn-sm btn-danger" 
                                    onclick="deleteComment({{ comment.id }})"></button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="comment-text" id="text-{{ comment.id }}">{{ comment.content }}</div>
                    
                    <div class="comment-edit-form" id="edit-{{ comment.id }}">
                        <textarea id="content-{{ comment.id }}" class="comment-textarea">{{ comment.content }}</textarea>
                        <div class="comment-form-actions">
                            <button class="btn btn-sm btn-primary" onclick="saveComment({{ comment.id }})">Save</button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelEdit({{ comment.id }})">Cancel</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-comments">
                <div class="empty-icon"></div>
                <p>No comments yet. Be the first!</p>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<!-- Edit Post Modal -->
<div id="postModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Edit Post</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        
        <form id="postForm">
            {% if user.is_staff %}
            <div class="form-group">
                <label>Post Type:</label>
                <select id="postType">
                    <option value="discussion">Discussion</option>
                    <option value="news">Official News</option>
                </select>
            </div>
            {% endif %}

            <div class="form-group">
                <label>Title:</label>
                <input type="text" id="postTitle" required>
            </div>

            <div class="form-group">
                <label>Content:</label>
                <textarea id="postContent" required></textarea>
            </div>

            <div class="form-group">
                <label>Tag Clubs:</label>
                <select id="postClubs" multiple size="6">
                    {% for club in user_favorite_clubs %}
                    <option value="{{ club.id }}">{{ club.name }}</option>
                    {% endfor %}
                </select>
                <small>Hold Ctrl/Cmd to select multiple</small>
            </div>

            <div class="form-group">
                <label>Images:</label>
                <div id="imagesContainer"></div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addImage()">+ Add Image</button>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
    const csrftoken = '{{ csrf_token }}';
    const postId = {{ post.id }};
    
    // Image data
    const images = [
        {% for img in post.images.all %}
        { url: '{{ img.image_url }}', caption: '{{ img.caption|escapejs }}' }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    let currentImageIdx = 0;
    
    function changeImage(direction) {
        currentImageIdx += direction;
        if (currentImageIdx < 0) currentImageIdx = images.length - 1;
        if (currentImageIdx >= images.length) currentImageIdx = 0;
        
        document.getElementById('mainImage').src = images[currentImageIdx].url;
        document.getElementById('currentImageIndex').textContent = currentImageIdx + 1;
        
        document.getElementById('prevImageBtn').disabled = false;
        document.getElementById('nextImageBtn').disabled = false;
    }
    
    function showAlert(msg, type) {
        const div = document.createElement('div');
        div.className = `alert alert-${type}`;
        div.textContent = msg;
        document.getElementById('alert-container').appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }
    
    // Edit/Delete Post
    function openEditModal() {
        fetch(`/forum/api/post/${postId}/data/`, {
            headers: { 'X-CSRFToken': csrftoken }
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                document.getElementById('postTitle').value = d.post.title;
                document.getElementById('postContent').value = d.post.content;
                {% if user.is_staff %}
                document.getElementById('postType').value = d.post.post_type;
                {% endif %}
                
                Array.from(document.getElementById('postClubs').options).forEach(o => {
                    o.selected = d.post.club_ids.includes(o.value);
                });
                
                const container = document.getElementById('imagesContainer');
                container.innerHTML = '';
                d.post.images.forEach(img => {
                    const div = document.createElement('div');
                    div.className = 'image-input';
                    div.innerHTML = `
                        <input type="url" class="image-url" value="${img.url}">
                        <input type="text" class="image-caption" value="${img.caption}">
                        <button type="button" class="btn-remove-image" onclick="this.parentElement.remove()">×</button>
                    `;
                    container.appendChild(div);
                });
                
                document.getElementById('postModal').style.display = 'block';
            }
        });
    }
    
    function closeModal() {
        document.getElementById('postModal').style.display = 'none';
    }
    
    function addImage() {
        const div = document.createElement('div');
        div.className = 'image-input';
        div.innerHTML = `
            <input type="url" class="image-url" placeholder="Image URL">
            <input type="text" class="image-caption" placeholder="Caption">
            <button type="button" class="btn-remove-image" onclick="this.parentElement.remove()">×</button>
        `;
        document.getElementById('imagesContainer').appendChild(div);
    }
    
    document.getElementById('postForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const images = [];
        document.querySelectorAll('.image-input').forEach(inp => {
            const url = inp.querySelector('.image-url').value;
            const caption = inp.querySelector('.image-caption').value;
            if (url) images.push({ url, caption });
        });
        
        const data = {
            title: document.getElementById('postTitle').value,
            content: document.getElementById('postContent').value,
            club_ids: Array.from(document.getElementById('postClubs').selectedOptions).map(o => o.value),
            images
        };
        
        {% if user.is_staff %}
        data.post_type = document.getElementById('postType').value;
        {% endif %}
        
        const r = await fetch(`/forum/api/post/${postId}/update/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(data)
        });
        
        const result = await r.json();
        if (result.success) {
            showAlert('Post updated!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(result.error, 'error');
        }
    });
    
    async function deletePost() {
        if (!confirm('Delete this post and all comments?')) return;
        
        const r = await fetch(`/forum/api/post/${postId}/delete/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrftoken }
        });
        
        if ((await r.json()).success) {
            showAlert('Post deleted!', 'success');
            setTimeout(() => window.location.href = '/forum/', 1000);
        }
    }
    
    // Comments
    document.getElementById('commentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const r = await fetch(`/forum/api/post/${postId}/comment/create/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ content: document.getElementById('commentContent').value })
        });
        
        if ((await r.json()).success) {
            showAlert('Comment posted!', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    });
    
    function editComment(id) {
        document.getElementById(`text-${id}`).style.display = 'none';
        document.getElementById(`edit-${id}`).style.display = 'block';
    }
    
    function cancelEdit(id) {
        document.getElementById(`text-${id}`).style.display = 'block';
        document.getElementById(`edit-${id}`).style.display = 'none';
    }
    
    async function saveComment(id) {
        const content = document.getElementById(`content-${id}`).value;
        const r = await fetch(`/forum/api/comment/${id}/update/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ content })
        });
        
        if ((await r.json()).success) {
            showAlert('Comment updated!', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    }
    
    async function deleteComment(id) {
        if (!confirm('Delete this comment?')) return;
        
        const r = await fetch(`/forum/api/comment/${id}/delete/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrftoken }
        });
        
        if ((await r.json()).success) {
            document.getElementById(`comment-${id}`).remove();
            showAlert('Comment deleted!', 'success');
        }
    }
</script>
{% endblock %}