{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }} - Forum{% endblock %}

{% block content %}
<div id="alert-container" class="fixed top-5 right-5 z-50"></div>

<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <a href="{% url 'forum:forum_home' %}" class="inline-block text-sm text-gray-600 hover:underline mb-4">← Back to Forum</a>

  <!-- POST CARD -->
  <article class="bg-white border border-[#ffd7aa] rounded-xl shadow-sm overflow-hidden">
    <!-- Inline content area -->
    <div class="p-6 flex flex-col gap-4">

      <!-- Title row with actions -->
      <div class="flex items-start justify-between gap-4">
        <div class="flex-1">
          <h1 class="text-2xl md:text-3xl font-['Orbitron'] text-[#fe8800] font-extrabold leading-tight">
            {{ post.title }}
          </h1>

          <div class="mt-2 flex flex-wrap items-center gap-3 text-xs text-gray-600">
            <div><strong>{{ post.author.username }}</strong></div>
            <div>
            {% if post.updated_at and post.created_at and post.updated_at|date:'U' > post.created_at|date:'U' %}
                <span>{{ post.updated_at|date:"M d, Y" }} | <em>Edited</em></span>
                {% elif post.created_at %}
                <span>{{ post.created_at|date:"M d, Y" }}</span>
                {% else %}
                <span>Unknown date</span>
                {% endif %}
            </div>
            <div>{{ comments.count }} comment{{ comments.count|pluralize }}</div>
          </div>
        </div>

        {% if user == post.author or user.is_staff %}
        <div class="flex-shrink-0 flex items-start gap-2">
          <button id="postEditBtn" class="text-sm text-[#fe8800] hover:underline">Edit</button>
          <button id="postDeleteBtn" class="text-sm text-red-600 hover:underline">Delete</button>
        </div>
        {% endif %}
      </div>

      <!-- Clubs -->
      {% if post.clubs.all %}
      <div class="flex flex-wrap gap-2">
        {% for club in post.clubs.all %}
          <span class="inline-flex items-center gap-2 bg-[#fffdfa] px-2 py-1 rounded text-xs font-['Tektur'] text-gray-700 border border-[#fde6ce]">
            {% if club.logo_url %}
              <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="w-4 h-4 object-contain">
            {% endif %}
            {{ club.name }}
          </span>
        {% endfor %}
      </div>
      {% endif %}

        <!-- Image carousel (inline between header and content) -->
        <div id="post-image-section" class="w-full">
        {% if post.images.all %}
            <div class="relative">
            <img id="mainImage" src="{{ post.images.first.image_url }}" alt="{{ post.title }}"
                class="w-full max-h-[48rem] object-cover rounded-md border border-[#ffd7aa]" />
            {% if post.images.count > 1 %}
            <div class="absolute top-2 right-2 flex items-center gap-2">
                <button id="prevImageBtn" class="bg-white/80 hover:bg-white text-gray-800 rounded-full px-3 py-1 shadow" onclick="changeImage(-1)">‹</button>
                <span class="bg-white/90 px-3 py-1 rounded text-sm font-semibold" >
                <span id="currentImageIndex">1</span> / {{ post.images.count }}
                </span>
                <button id="nextImageBtn" class="bg-white/80 hover:bg-white text-gray-800 rounded-full px-3 py-1 shadow" onclick="changeImage(1)">›</button>
            </div>
            {% endif %}

            <!-- Caption (shows if caption exists for current image) -->
            <div id="imageCaption" class="mt-2 text-sm text-gray-600">
                {% if post.images.first.caption %}
                {{ post.images.first.caption }}
                {% endif %}
            </div>
            </div>
        {% endif %}
        </div>

      <!-- Post content -->
      <div id="postContent" class="prose max-w-none text-gray-800">
        {{ post.content|linebreaks }}
      </div>

      {# Inline edit area for the post (hidden until editing) #}
      <div id="postEditArea" class="hidden flex flex-col gap-3">
        <input id="postTitleInput" class="border border-[#ffd7aa] rounded px-3 py-2 w-full" />
        {% if user.is_staff %}
        <select id="postTypeInput" class="border border-[#ffd7aa] rounded px-3 py-2 w-48">
          <option value="discussion">Discussion</option>
          <option value="news">Official News</option>
        </select>
        {% endif %}
        <textarea id="postContentInput" class="border border-[#ffd7aa] rounded px-3 py-2 w-full h-40"></textarea>

        <div class="flex items-center gap-2">
          <button id="postSaveBtn" class="px-4 py-2 bg-gradient-to-br from-[#fe8800] to-[#ffb054] text-white rounded font-semibold">Save</button>
          <button id="postCancelBtn" class="px-4 py-2 bg-[#ffd7aa] text-[#333] rounded">Cancel</button>
        </div>
      </div>

    </div> <!-- end p-6 -->

    <!-- Divider -->
    <div class="border-t border-[#ffd7aa]"></div>

    <!-- Comment form (below post, before comments) -->
    <div class="p-6 bg-[#fffdfa]">
      {% if user.is_authenticated %}
      <form id="commentForm" class="flex flex-col gap-3">
        {% csrf_token %}
        <label class="text-sm font-semibold text-gray-700">Add a comment</label>
        <textarea id="commentContent" class="border border-[#ffd7aa] rounded px-3 py-2 w-full h-24" placeholder="Share your thoughts..." required></textarea>
        <div class="flex items-center gap-3">
          <button type="submit" class="px-4 py-2 bg-[#fe8800] text-white rounded font-semibold">Post Comment</button>
          <span id="commentStatus" class="text-sm text-gray-500"></span>
        </div>
      </form>
      {% else %}
      <p class="text-sm text-gray-600"><a href="{% url 'main:login' %}" class="text-[#fe8800] hover:underline">Login</a> to join the discussion</p>
      {% endif %}
    </div>

    <!-- Comments section -->
    <div class="p-6">
      <h2 class="text-lg font-['Orbitron'] text-[#fe8800] mb-4">Comments ({{ comments.count }})</h2>

      <div id="commentsList" class="flex flex-col gap-4">
        {% if comments %}
          {% for comment in comments %}
            <div id="comment-{{ comment.id }}" class="bg-white border border-[#f0e0d0] rounded p-4">
              <div class="flex items-start justify-between gap-4">
                <div class="flex items-start gap-3">
                  <div class="flex items-center justify-center w-10 h-10 bg-[#ffd7aa] text-white rounded-full font-bold">
                    {{ comment.author.username|first|upper }}
                  </div>
                  <div>
                    <div class="text-sm font-semibold">{{ comment.author.username }}</div>
                    <div class="text-xs text-gray-500">
                    {% if post.updated_at and post.created_at and post.updated_at|date:'U' > post.created_at|date:'U' %}
                        <span>{{ post.updated_at|date:"M d, Y" }} | <em>Edited</em></span>
                        {% elif post.created_at %}
                        <span>{{ post.created_at|date:"M d, Y" }}</span>
                        {% else %}
                        <span>Unknown date</span>
                        {% endif %}
                    </div>
                  </div>
                </div>

                {% if user == comment.author or user.is_staff %}
                <div class="flex items-center gap-2">
                  <button class="text-sm text-[#fe8800] hover:underline" onclick="startEditComment({{ comment.id }})">Edit</button>
                  <button class="text-sm text-red-600 hover:underline" onclick="deleteComment({{ comment.id }})">Delete</button>
                </div>
                {% endif %}
              </div>

              <!-- comment text -->
              <div id="text-{{ comment.id }}" class="mt-3 text-gray-700">
                {{ comment.content|linebreaks }}
              </div>

              <!-- inline edit area for comment -->
              <div id="edit-{{ comment.id }}" class="hidden mt-3">
                <textarea id="content-{{ comment.id }}" class="border border-[#ffd7aa] rounded px-3 py-2 w-full h-24">{{ comment.content }}</textarea>
                <div class="flex items-center gap-2 mt-2">
                  <button class="px-3 py-1 bg-[#fe8800] text-white rounded text-sm" onclick="saveComment({{ comment.id }})">Save</button>
                  <button class="px-3 py-1 bg-[#ffd7aa] text-[#333] rounded text-sm" onclick="cancelEdit({{ comment.id }})">Cancel</button>
                </div>
              </div>

              <!-- replies (one-level only) -->
              {% if comment.replies %}
                <div class="mt-4 border-l-2 border-[#ffd7aa] pl-4">
                  {% for reply in comment.replies %}
                    <div id="comment-{{ comment.id }}" class="bg-white border border-[#f0e0d0] rounded p-4">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex items-start gap-3">
                            <div class="flex items-center justify-center w-10 h-10 bg-[#ffd7aa] text-white rounded-full font-bold">
                                {{ comment.author.username|first|upper }}
                            </div>
                            <div>
                                <div class="text-sm font-semibold">{{ comment.author.username }}</div>
                                <div class="text-xs text-gray-500">
                                {% if post.updated_at and post.created_at and post.updated_at|date:'U' > post.created_at|date:'U' %}
                                    <span>{{ post.updated_at|date:"M d, Y" }} | <em>Edited</em></span>
                                    {% elif post.created_at %}
                                    <span>{{ post.created_at|date:"M d, Y" }}</span>
                                    {% else %}
                                    <span>Unknown date</span>
                                    {% endif %}
                                </div>
                            </div>
                            </div>

                            {% if user == comment.author or user.is_staff %}
                            <div class="flex items-center gap-2">
                            <button class="text-sm text-[#fe8800] hover:underline" onclick="startEditComment({{ comment.id }})">Edit</button>
                            <button class="text-sm text-red-600 hover:underline" onclick="deleteComment({{ comment.id }})">Delete</button>
                            </div>
                            {% endif %}
                        </div>

                        <!-- comment text -->
                        <div id="text-{{ comment.id }}" class="mt-3 text-gray-700">
                            {{ comment.content|linebreaks }}
                        </div>

                        <!-- inline edit area for comment -->
                        <div id="edit-{{ comment.id }}" class="hidden mt-3">
                            <textarea id="content-{{ comment.id }}" class="border border-[#ffd7aa] rounded px-3 py-2 w-full h-24">{{ comment.content }}</textarea>
                            <div class="flex items-center gap-2 mt-2">
                            <button class="px-3 py-1 bg-[#fe8800] text-white rounded text-sm" onclick="saveComment({{ comment.id }})">Save</button>
                            <button class="px-3 py-1 bg-[#ffd7aa] text-[#333] rounded text-sm" onclick="cancelEdit({{ comment.id }})">Cancel</button>
                            </div>
                        </div>

                        <!-- Reply button + inline reply form (one-level replies) -->
                        {% if user.is_authenticated %}
                            <div class="mt-3">
                            <button id="replyBtn-{{ comment.id }}" class="text-sm text-[#fe8800] hover:underline" onclick="toggleReplyForm({{ comment.id }})">Reply</button>

                            <div id="replyForm-{{ comment.id }}" class="hidden mt-2">
                                <textarea id="replyContent-{{ comment.id }}" class="border border-[#ffd7aa] rounded px-3 py-2 w-full h-20" placeholder="Write your reply..."></textarea>
                                <div class="flex items-center gap-2 mt-2">
                                <button class="px-3 py-1 bg-[#fe8800] text-white rounded text-sm" onclick="submitReply({{ comment.id }})">Reply</button>
                                <button class="px-3 py-1 bg-[#ffd7aa] text-[#333] rounded text-sm" onclick="toggleReplyForm({{ comment.id }})">Cancel</button>
                                </div>
                                <div id="replyStatus-{{ comment.id }}" class="text-xs text-gray-500 mt-2"></div>
                            </div>
                            </div>
                        {% endif %}

                        <!-- replies (one-level only) -->
                        {% if comment.replies %}
                            <div class="mt-4 border-l-2 border-[#ffd7aa] pl-4">
                            {% for reply in comment.replies %}
                                <div id="comment-{{ reply.id }}" class="bg-white border border-[#f7efe0] rounded p-3 mb-3">
                                ...  <!-- keep your existing reply rendering (no changes) -->
                                </div>
                            {% endfor %}
                            </div>
                        {% endif %}
                        </div>

                  {% endfor %}
                </div>
              {% endif %}

            </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-gray-500 py-8">No comments yet. Be the first!</div>
        {% endif %}
      </div>
    </div>

  </article>
</div>

<script>
    // CSRF + postId + images
    const csrftoken = '{{ csrf_token }}';
    const postId = {{ post.id }};
    const images = [
    {% for img in post.images.all %}
        {
        url: '{{ img.image_url|escapejs }}',
        caption: '{{ img.caption|default:""|escapejs }}'
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ];
    let currentImageIdx = 0;

  function showAlert(msg, type='success') {
    const container = document.getElementById('alert-container');
    const div = document.createElement('div');
    div.className = `rounded px-4 py-2 mb-2 shadow ${type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`;
    div.textContent = msg;
    container.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }

  // Helper to set image + caption safely
  function setMainImage(idx) {
    if (!images.length) return;
    const img = images[idx];
    const mainImage = document.getElementById('mainImage');
    if (mainImage && img) mainImage.src = img.url;
    const idxEl = document.getElementById('currentImageIndex');
    if (idxEl) idxEl.textContent = idx + 1;
    const captionEl = document.getElementById('imageCaption');
    if (captionEl) captionEl.textContent = img.caption || '';
  }
    
  // Image navigation
  function changeImage(direction) {
    if (!images.length) return;
    currentImageIdx += direction;
    if (currentImageIdx < 0) currentImageIdx = images.length - 1;
    if (currentImageIdx >= images.length) currentImageIdx = 0;
    setMainImage(currentImageIdx);
  }
  
  // set initial caption correctly on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', () => {
    setMainImage(0);
  })

  // Inline post edit flow
  const postEditBtn = document.getElementById('postEditBtn');
  const postDeleteBtn = document.getElementById('postDeleteBtn');
  const postEditArea = document.getElementById('postEditArea');
  const postContentEl = document.getElementById('postContent');
  const postTitleInput = document.getElementById('postTitleInput');
  const postContentInput = document.getElementById('postContentInput');

  if (postEditBtn) {
    postEditBtn.addEventListener('click', async () => {
      // load current content via API (safe)
      const res = await fetch(`/forum/api/post/${postId}/data/`, { headers: {'X-CSRFToken': csrftoken} });
      const data = await res.json();
      if (data.success) {
        postTitleInput.value = data.post.title;
        postContentInput.value = data.post.content;
        {% if user.is_staff %}
        document.getElementById('postTypeInput').value = data.post.post_type;
        {% endif %}
        postEditArea.classList.remove('hidden');
        postContentEl.classList.add('hidden');
        postEditBtn.classList.add('hidden');
      } else {
        showAlert('Failed to load post data', 'error');
      }
    });
  }

  // Cancel edit
  document.getElementById('postCancelBtn')?.addEventListener('click', () => {
    postEditArea.classList.add('hidden');
    postContentEl.classList.remove('hidden');
    postEditBtn?.classList.remove('hidden');
  });

  // Save edited post (PUT)
  document.getElementById('postSaveBtn')?.addEventListener('click', async () => {
    const formData = new FormData();
    formData.append('title', postTitleInput.value);
    formData.append('content', postContentInput.value);
    {% if user.is_staff %}
    formData.append('post_type', document.getElementById('postTypeInput').value);
    {% endif %}

    const newFiles = document.getElementById('newImages')?.files;
    if (newFiles && newFiles.length > 0) {
    for (const f of newFiles) {
        formData.append('images', f);
    }
    }

    const captions = document.getElementById('imageCaptions')?.value.split(',').map(c => c.trim());
    if (newFiles && newFiles.length > 0) {
    for (let i = 0; i < newFiles.length; i++) {
        formData.append('images', newFiles[i]);
        if (captions && captions[i]) {
        formData.append(`caption_${i}`, captions[i]);
        }
    }
    }

    const r = await fetch(`/forum/api/post/${postId}/update/`, {
    method: 'POST', // use POST since we're now sending files
    headers: { 'X-CSRFToken': csrftoken },
    body: formData
    });

    const result = await r.json();
    if (result.success) {
    showAlert('Post updated!', 'success');

    // update DOM directly from form inputs
    const newTitle = postTitleInput.value;
    const newContent = postContentInput.value;

    document.querySelector('h1').textContent = newTitle;
    postContentEl.innerHTML = newContent.replace(/\n/g, '<br>');

    postEditArea.classList.add('hidden');
    postContentEl.classList.remove('hidden');
    postEditBtn?.classList.remove('hidden');
    } else {
    showAlert(result.error || 'Failed to update', 'error');
    }
  });

  // Delete post
  if (postDeleteBtn) {
    postDeleteBtn.addEventListener('click', async () => {
      if (!confirm('Delete this post and all comments?')) return;
      const r = await fetch(`/forum/api/post/${postId}/delete/`, {
        method: 'DELETE',
        headers: {'X-CSRFToken': csrftoken}
      });
      const j = await r.json();
      if (j.success) {
        showAlert('Post deleted!', 'success');
        setTimeout(() => window.location.href = "{% url 'forum:forum_home' %}", 900);
      } else {
        showAlert(j.error || 'Could not delete', 'error');
      }
    });
  }

  // Create comment (top-level)
  document.getElementById('commentForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = document.getElementById('commentContent').value.trim();
    if (!content) return;
    const r = await fetch(`/forum/api/post/${postId}/comment/create/`, {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
      body: JSON.stringify({content})
    });
    const j = await r.json();
    if (j.success) {
      showAlert('Comment posted!', 'success');
      setTimeout(() => location.reload(), 600);
    } else {
      showAlert(j.error || 'Failed to post comment', 'error');
    }
  });

  // Edit / Delete comment helpers
  function startEditComment(id) {
    document.getElementById(`text-${id}`).style.display = 'none';
    document.getElementById(`edit-${id}`).style.display = 'block';
  }
  function cancelEdit(id) {
    document.getElementById(`edit-${id}`).style.display = 'none';
    document.getElementById(`text-${id}`).style.display = 'block';
  }

  // Save edited comment (PUT)
  async function saveComment(id) {
    const content = document.getElementById(`content-${id}`).value.trim();
    if (!content) return;
    const r = await fetch(`/forum/api/comment/${id}/update/`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
      body: JSON.stringify({content})
    });
    const j = await r.json();
    if (j.success) {
      showAlert('Comment updated!', 'success');
      // update DOM
      document.getElementById(`text-${id}`).innerHTML = content.replace(/\n/g,'<br>');
      cancelEdit(id);
    } else {
      showAlert(j.error || 'Failed to update comment', 'error');
    }
  }

  // toggle reply form visibility
  function toggleReplyForm(commentId) {
    const form = document.getElementById(`replyForm-${commentId}`);
    if (!form) return;
    form.classList.toggle('hidden');
  }

 // submit a reply via AJAX (POST with parent_id)
  async function submitReply(parentId) {
    const textarea = document.getElementById(`replyContent-${parentId}`);
    const statusEl = document.getElementById(`replyStatus-${parentId}`);
    if (!textarea) return;
    const content = textarea.value.trim();
    if (!content) {
      if (statusEl) statusEl.textContent = 'Please write a reply.';
      return;
    }
    if (statusEl) statusEl.textContent = 'Posting...';

    try {
      const r = await fetch(`/forum/api/post/${postId}/comment/create/`, {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({ content, parent_id: parentId })
      });
      const j = await r.json();
      if (j.success) {
        if (statusEl) statusEl.textContent = 'Reply posted!';
        // Option A: insert reply into DOM without full reload (if API returns reply HTML or data).
        // Simpler & robust: reload the page to reflect new reply and counts.
        setTimeout(() => location.reload(), 500);
      } else {
        if (statusEl) statusEl.textContent = j.error || 'Failed to post reply';
      }
    } catch (err) {
      if (statusEl) statusEl.textContent = 'Network error';
    }
  }

  // Delete comment
  async function deleteComment(id) {
    if (!confirm('Delete this comment?')) return;
    const r = await fetch(`/forum/api/comment/${id}/delete/`, {
      method: 'DELETE',
      headers: {'X-CSRFToken': csrftoken}
    });
    const j = await r.json();
    if (j.success) {
      showAlert('Comment deleted', 'success');
      document.getElementById(`comment-${id}`)?.remove();
    } else {
      showAlert(j.error || 'Failed to delete', 'error');
    }
  }
</script>
{% endblock %}
