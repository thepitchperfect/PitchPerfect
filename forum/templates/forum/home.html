{% extends 'base.html' %}
{% load static %}

{% block title %}Soccer Forum{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'forum/css/forum.css' %}">
{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="forum-layout">
    <!-- Sidebar Filters -->
    <aside class="forum-sidebar">
        <h3 class="sidebar-title">FILTERS</h3>
        
        <form id="filterForm">
            <!-- Clubs Multi-Select with Search (Only Favorite Clubs) -->
            <div class="filter-group">
                <label>Filter by Your Clubs:</label>
                {% if user.is_authenticated %}
                    {% if user_favorite_clubs %}
                        <input type="text" id="clubSearch" class="club-search" placeholder="Search your clubs...">
                        <div class="clubs-multiselect" id="clubsMultiselect">
                            {% for club in user_favorite_clubs %}
                            <div class="club-checkbox" data-club-name="{{ club.name|lower }}">
                                <input type="checkbox" name="clubs" value="{{ club.id }}" 
                                       id="club-{{ club.id }}"
                                       {% if club.id|stringformat:"s" in current_filters.clubs %}checked{% endif %}>
                                <label for="club-{{ club.id }}">{{ club.name }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p style="color: #666; font-size: 0.9rem; padding: 1rem; background: #ffd7aa30; border-radius: 8px;">
                            You haven't added any favorite clubs yet. Go to your profile to add some!
                        </p>
                    {% endif %}
                {% else %}
                    <p style="color: #666; font-size: 0.9rem; padding: 1rem; background: #ffd7aa30; border-radius: 8px;">
                        üîê <a href="{% url 'login' %}" style="color: #fe8800; font-weight: bold;">Login</a> to filter by your clubs
                    </p>
                {% endif %}
            </div>



            <!-- Search -->
            <div class="filter-group">
                <label>Search:</label>
                <input type="text" name="search" id="searchInput" 
                       placeholder="Search posts..." 
                       value="{{ current_filters.search|default:'' }}">
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-primary btn-sm btn-block">Apply Filters</button>
                <button type="button" class="btn btn-secondary btn-sm btn-block" onclick="clearFilters()">
                    Clear All
                </button>
            </div>
        </form>
    </aside>

    <!-- Main Content -->
    <main class="forum-main">
        <!-- Forum Header -->
        <div class="forum-header">
            <h1 class="forum-title">PITCHPERFECT FORUM</h1>
            {% if user.is_authenticated %}
            <button class="btn btn-primary" onclick="openCreateModal()">
                {% if user.is_staff %}CREATE POST{% else %}CREATE POST{% endif %}
            </button>
            {% else %}
            <p class="login-prompt">
                <a href="{% url 'login' %}">Login</a> to create posts and join discussions
            </p>
            {% endif %}
        </div>

        <!-- News Carousel -->
        {% if news_posts %}
        <section class="news-carousel-section">
            <div class="carousel-header">
                <h2 class="carousel-title">Official News</h2>
                <div class="carousel-controls">
                    <button class="carousel-btn" id="prevBtn" onclick="prevSlide()">‚Äπ</button>
                    <button class="carousel-btn" id="nextBtn" onclick="nextSlide()">‚Ä∫</button>
                </div>
            </div>

            <div class="news-carousel">
                <div class="carousel-track" id="carouselTrack">
                    {% for news in news_posts %}
                    {% if forloop.counter0|divisibleby:3 or forloop.first %}
                    <div class="carousel-slide">
                    {% endif %}
                        
                        {% with slide_index=forloop.counter0|add:"0"|divisibleby:3 %}
                        {% with position=forloop.counter0|add:"0" %}
                        
                        <article class="news-card {% if position|divisibleby:3 %}large{% else %}small{% endif %}"
                                 onclick="window.location.href='{% url 'post_detail' news.id %}'">
                            <span class="news-badge">OFFICIAL</span>
                            
                            
                            {% if news.images.first %}
                            <img src="{{ news.images.first.image_url }}" alt="{{ news.title }}" class="news-image">
                            {% else %}
                            <div class="news-image"></div>
                            {% endif %}
                            
                            <div class="news-content">

                                <div class="news-clubs">
                                    {% for club in news.clubs.all|slice:":2" %}
                                    <span class="club-badge">
                                        {% if club.logo_url %}
                                        <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo">
                                        {% endif %}
                                        {{ club.name }}
                                    </span>
                                    {% endfor %}
                                </div>

                                <h3 class="news-title">{{ news.title }}</h3>
                                
                                <div class="news-meta">
                                    <span>{{ news.author.username }}</span>
                                    {% if news.updated_at > news.created_at %}
                                    <span>{{ news.updated_at|date:"M d, Y" }} ‚Ä¢ <em>Edited</em></span>
                                    {% else %}
                                    <span>{{ news.created_at|date:"M d, Y" }}</span>
                                    {% endif %}
                                </div>
                                

                                <p class="news-excerpt">{{ news.content|truncatewords:30 }}</p>
                                
                                <div class="news-footer">
                                    <span class="comment-count">{{ news.comments.count }} comments</span>
                                    <span class="btn btn-primary btn-sm">Read More ‚Üí</span>
                                </div>
                            </div>
                        </article>
                        
                        {% endwith %}
                        {% endwith %}
                    
                    {% if forloop.counter|divisibleby:3 or forloop.last %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            
            <div class="carousel-dots" id="carouselDots"></div>
        </section>
        {% endif %}

        <!-- Discussion Posts -->
        <div class="posts-container">
            <h2 style="font-family: 'Orbitron', sans-serif; color: #fe8800; margin-bottom: 1rem; text-transform: uppercase;">
                Discussions
            </h2>
            
            {% for post in page_obj %}
            <article class="post-card" id="post-{{ post.id }}">

                <div class="post-header">
                    <div class="post-info">
                        <!-- Club and Tags -->
                        <div class="post-clubs">
                            {% for club in post.clubs.all %}
                            <span class="club-badge">
                                {% if club.logo_url %}
                                <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo">
                                {% endif %}
                                {{ club.name }}
                            </span>
                            {% endfor %}
                        </div>

                        <h2 class="post-title">
                            <a href="{% url 'post_detail' post.id %}">{{ post.title }}</a>
                        </h2>
                        
                        <div class="post-meta">
                            <span><strong>{{ post.author.username }}</strong></span>
                            {% if post.updated_at|date:"U" > post.created_at|date:"U" %}
                                <span>{{ post.updated_at|date:"M d, Y H:i" }} | <em>Edited</em></span>
                            {% else %}
                                <span>{{ post.created_at|date:"M d, Y H:i" }}</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if user == post.author or user.is_staff %}
                    <div class="post-actions">
                        <a href="#" onclick="openEditModal({{ post.id }})" class="font-lato" >Edit | </a>
                        <a href="#" onclick="deletePost({{ post.id }})" class="delete-link">Delete</a>
                    </div>
                    {% endif %}
                </div>

                <!-- Post Images -->
                {% if post.images.all %}
                <div class="post-images">
                    {% for image in post.images.all|slice:":4" %}
                    <img src="{{ image.image_url }}" alt="{{ image.caption }}" class="post-image">
                    {% endfor %}
                    {% if post.images.count > 4 %}
                    <div class="more-images">+{{ post.images.count|add:"-4" }} more</div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="post-content">
                    {{ post.content|truncatewords:50 }}
                </div>

                <div class="post-footer">
                    <span class="comment-count">{{ post.comment_count }} comment{{ post.comment_count|pluralize }}</span>
                    <!-- <a href="{% url 'post_detail' post.id %}" class="btn btn-primary btn-sm">
                        View Discussion ‚Üí
                    </a> -->
                </div>
            </article>
            {% empty %}
            <div class="empty-state">
                <h3>No Discussions Found</h3>
                <p>
                    {% if current_filters.search or current_filters.clubs or current_filters.league %}
                        Try adjusting your filters or <a href="{% url 'forum_home' %}">view all posts</a>
                    {% else %}
                        Be the first to start a discussion!
                    {% endif %}
                </p>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
            <a href="?page=1&{{ request.GET.urlencode }}" class="btn btn-sm btn-secondary">¬´ First</a>
            <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" 
               class="btn btn-sm btn-secondary">‚Äπ Previous</a>
            {% endif %}
            
            <span class="current-page">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" 
               class="btn btn-sm btn-secondary">Next ‚Ä∫</a>
            <a href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode }}" 
               class="btn btn-sm btn-secondary">Last ¬ª</a>
            {% endif %}
        </div>
        {% endif %}
    </main>
</div>

<!-- Create/Edit Post Modal -->
<div id="postModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Create Post</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        
        <form id="postForm">
            {% if user.is_staff %}
            <div class="form-group">
                <label>Post Type:</label>
                <select id="postType">
                    <option value="discussion">üí¨ Discussion</option>
                    <option value="news">üì∞ Official News</option>
                </select>
            </div>
            {% endif %}

            <div class="form-group">
                <label>Title:</label>
                <input type="text" id="postTitle" required placeholder="Enter post title">
            </div>

            <div class="form-group">
                <label>Content:</label>
                <textarea id="postContent" required placeholder="Share your thoughts..."></textarea>
            </div>

            <div class="form-group">
                <label>Tag Clubs (up to 3):</label>
                <div id="dynamicClubFields"></div>
                <small>You can tag up to 3 clubs. Remove a tag to add another.</small>
            </div>

            <div class="form-group">
                <label>Image URLs (optional):</label>
                <div class="image-inputs" id="imagesContainer">
                    <div class="image-input">
                        <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                        <input type="text" class="image-caption" placeholder="Caption">
                        <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addImageInput()" style="margin-top: 0.5rem;">
                    + Add Image
                </button>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    let editingPostId = null;
    
    // Club Search Functionality
    const clubSearch = document.getElementById('clubSearch');
    if (clubSearch) {
        clubSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const checkboxes = document.querySelectorAll('.club-checkbox');
            
            checkboxes.forEach(checkbox => {
                const clubName = checkbox.getAttribute('data-club-name');
                if (clubName.includes(searchTerm)) {
                    checkbox.classList.remove('hidden');
                } else {
                    checkbox.classList.add('hidden');
                }
            });
        });
    }

    // --- Dynamic club tagging (max 3) ---
    const clubs = [
        {% for club in clubs %}
        {id: '{{ club.id }}', name: '{{ club.name }}', league: '{{ club.league.name }}'},
        {% endfor %}
    ];
    const dynamicClubFields = document.getElementById('dynamicClubFields');
    let clubTags = [];

    function renderClubFields() {
        dynamicClubFields.innerHTML = '';
        // Render tags
        clubTags.forEach((club, idx) => {
            const tag = document.createElement('span');
            tag.className = 'dynamic-club-tag';
            tag.dataset.id = club.id;
            // Add text node for club name
            tag.appendChild(document.createTextNode(club.name + ' - ' + club.league));
            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '√ó';
            removeBtn.className = 'remove-club-btn';
            removeBtn.onclick = function() {
                clubTags = clubTags.filter((_, i) => i !== idx);
                renderClubFields();
            };
            tag.appendChild(removeBtn);
            dynamicClubFields.appendChild(tag);
        });
        // Render new input if less than 3
        if (clubTags.length < 3) {
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Type to search clubs...';
            input.setAttribute('list', 'clubsDatalist');
            input.className = 'club-search-input';
            input.autocomplete = 'off';
            input.addEventListener('change', function(e) {
                const val = input.value.trim();
                if (!val) return;
                const match = clubs.find(c => (c.name + ' - ' + c.league) === val);
                if (match && !clubTags.some(t => t.id === match.id)) {
                    clubTags.push(match);
                    renderClubFields();
                }
                input.value = '';
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.dispatchEvent(new Event('change'));
                }
            });
            dynamicClubFields.appendChild(input);
        }
    }
    // Datalist for club search
    if (!document.getElementById('clubsDatalist')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'clubsDatalist';
        clubs.forEach(club => {
            const opt = document.createElement('option');
            opt.value = club.name + ' - ' + club.league;
            opt.dataset.id = club.id;
            datalist.appendChild(opt);
        });
        document.body.appendChild(datalist);
    }
    renderClubFields();

    // For edit: prepopulate clubTags if editing
    window.prefillClubTags = function(ids) {
        clubTags = clubs.filter(c => ids.includes(c.id));
        renderClubFields();
    }
    // Club search and tagging logic
    const clubSearchInput = document.getElementById('clubSearchInput');
    const clubsDatalist = document.getElementById('clubsDatalist');
    const selectedClubsContainer = document.getElementById('selectedClubsContainer');
    let selectedClubsSet = new Set();

    if (clubSearchInput && clubsDatalist && selectedClubsContainer) {
        clubSearchInput.addEventListener('change', function(e) {
            const inputValue = clubSearchInput.value.trim();
            if (!inputValue) return;
            // Find the option with this value
            const option = Array.from(clubsDatalist.options).find(opt => opt.value === inputValue);
            if (option && !selectedClubsSet.has(option.dataset.id)) {
                selectedClubsSet.add(option.dataset.id);
                const span = document.createElement('span');
                span.className = 'selected-club';
                span.dataset.id = option.dataset.id;
                span.textContent = option.value;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = '√ó';
                removeBtn.className = 'remove-club-btn';
                removeBtn.onclick = function() {
                    selectedClubsSet.delete(option.dataset.id);
                    span.remove();
                };
                span.appendChild(removeBtn);
                selectedClubsContainer.appendChild(span);
                clubSearchInput.value = '';
            }
        });
        // Optional: Add on Enter key
        clubSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clubSearchInput.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Carousel functionality
    let currentSlide = 0;
    const totalSlides = Math.ceil({{ news_posts.count }} / 3) || 1;
    let autoplayInterval;
    
    function updateCarousel() {
        const track = document.getElementById('carouselTrack');
        if (track) {
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            // Update dots
            const dots = document.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlide);
            });
            
            // Update button states
            document.getElementById('prevBtn').disabled = currentSlide === 0;
            document.getElementById('nextBtn').disabled = currentSlide === totalSlides - 1;
        }
    }
    
    function nextSlide() {
        if (currentSlide < totalSlides - 1) {
            currentSlide++;
            updateCarousel();
            resetAutoplay();
        }
    }
    
    function prevSlide() {
        if (currentSlide > 0) {
            currentSlide--;
            updateCarousel();
            resetAutoplay();
        }
    }
    
    function goToSlide(index) {
        currentSlide = index;
        updateCarousel();
        resetAutoplay();
    }
    
    function startAutoplay() {
        autoplayInterval = setInterval(() => {
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
            } else {
                currentSlide = 0;
            }
            updateCarousel();
        }, 5000); // Auto-advance every 5 seconds
    }
    
    function resetAutoplay() {
        clearInterval(autoplayInterval);
        startAutoplay();
    }
    
    // Initialize carousel
    if (document.getElementById('carouselTrack')) {
        // Create dots
        const dotsContainer = document.getElementById('carouselDots');
        for (let i = 0; i < totalSlides; i++) {
            const dot = document.createElement('div');
            dot.className = 'carousel-dot';
            if (i === 0) dot.classList.add('active');
            dot.onclick = () => goToSlide(i);
            dotsContainer.appendChild(dot);
        }
        
        // Start autoplay
        startAutoplay();
        
        // Pause on hover
        const carousel = document.querySelector('.news-carousel');
        carousel.addEventListener('mouseenter', () => clearInterval(autoplayInterval));
        carousel.addEventListener('mouseleave', () => startAutoplay());
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        document.getElementById('alert-container').appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
    }
    
    // Filter handling
    document.getElementById('filterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const params = new URLSearchParams();
        
        // Get all checked clubs
        const clubs = [];
        document.querySelectorAll('input[name="clubs"]:checked').forEach(cb => {
            clubs.push(cb.value);
        });
        clubs.forEach(club => params.append('clubs', club));
        
        const league = formData.get('league');
        const search = formData.get('search');
        
        if (league) params.append('league', league);
        if (search) params.append('search', search);
        
        window.location.href = '{% url "forum_home" %}?' + params.toString();
    });
    
    function clearFilters() {
        window.location.href = '{% url "forum_home" %}';
    }
    
    // Modal functions
    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Create Post';
        document.getElementById('postForm').reset();
        editingPostId = null;
        
        // Reset image inputs
        document.getElementById('imagesContainer').innerHTML = `
            <div class="image-input">
                <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                <input type="text" class="image-caption" placeholder="Caption">
                <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
            </div>
        `;
        
        document.getElementById('postModal').style.display = 'block';
        renderClubFields();
    }
    
    function openEditModal(postId) {
        editingPostId = postId;
        document.getElementById('modalTitle').textContent = 'Edit Post';
        
        // Fetch post data via AJAX
        fetch(`/forum/api/post/${postId}/data/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const post = data.post;
                
                // Populate form fields
                document.getElementById('postTitle').value = post.title;
                document.getElementById('postContent').value = post.content;
                
                // Set post type if admin
                {% if user.is_staff %}
                if (document.getElementById('postType')) {
                    document.getElementById('postType').value = post.post_type;
                }
                {% endif %}
                
                // Select clubs
                const clubsSelect = document.getElementById('postClubs');
                if (clubsSelect) {
                    Array.from(clubsSelect.options).forEach(option => {
                        option.selected = post.club_ids.includes(option.value);
                    });
                }
                
                // Select league
                const leagueSelect = document.getElementById('postLeague');
                if (leagueSelect) {
                    leagueSelect.value = post.league_id || '';
                }
                
                // Populate images
                const imagesContainer = document.getElementById('imagesContainer');
                imagesContainer.innerHTML = '';
                
                if (post.images && post.images.length > 0) {
                    post.images.forEach(img => {
                        const div = document.createElement('div');
                        div.className = 'image-input';
                        div.innerHTML = `
                            <input type="url" class="image-url" placeholder="https://example.com/image.jpg" value="${img.url}">
                            <input type="text" class="image-caption" placeholder="Caption" value="${img.caption || ''}">
                            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)">Remove Image</button>
                        `;
                        imagesContainer.appendChild(div);
                    });
                } else {
                    // Add empty image input
                    imagesContainer.innerHTML = `
                        <div class="image-input">
                            <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                            <input type="text" class="image-caption" placeholder="Caption">
                            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
                        </div>
                    `;
                }
                
                // Show modal
                document.getElementById('postModal').style.display = 'block';
                prefillClubTags(post.club_ids);
                renderClubFields();
            } else {
                showAlert(data.error || 'Failed to load post data', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to load post data: ' + error.message, 'error');
        });
    }
    
    function closeModal() {
        document.getElementById('postModal').style.display = 'none';
    }
    
    function addImageInput() {
        const container = document.getElementById('imagesContainer');
        const div = document.createElement('div');
        div.className = 'image-input';
        div.innerHTML = `
            <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
            <input type="text" class="image-caption" placeholder="Caption">
            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)">Remove Image</button>
        `;
        container.appendChild(div);
    }
    
    function removeImageInput(btn) {
        btn.closest('.image-input').remove();
    }
    
    // Form submission
    document.getElementById('postForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Collect images
        const images = [];
        document.querySelectorAll('.image-input').forEach(input => {
            const url = input.querySelector('.image-url').value;
            const caption = input.querySelector('.image-caption').value;
            if (url) images.push({ url, caption });
        });
        
        // Collect selected clubs from dynamic fields
        const selectedClubs = Array.from(document.querySelectorAll('.dynamic-club-tag'))
            .map(el => el.dataset.id);
    
        
        const data = {
            title: document.getElementById('postTitle').value,
            content: document.getElementById('postContent').value,
            club_ids: selectedClubs,
            league_id: document.getElementById('postLeague') ? document.getElementById('postLeague').value : null,
            images: images
        };
        
        {% if user.is_staff %}
        data.post_type = document.getElementById('postType').value;
        {% endif %}
        
        const url = editingPostId 
            ? `/forum/api/post/${editingPostId}/update/`
            : '/forum/api/post/create/';
        const method = editingPostId ? 'PUT' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(editingPostId ? 'Post updated!' : 'Post created!', 'success');
                closeModal();
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(result.error || 'An error occurred', 'error');
            }
        } catch (error) {
            showAlert('An error occurred', 'error');
        }
    });
    
    async function deletePost(id) {
        if (!confirm('Are you sure you want to delete this post?')) return;
        
        try {
            const response = await fetch(`/forum/api/post/${id}/delete/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Post deleted!', 'success');
                document.getElementById(`post-${id}`).remove();
            } else {
                showAlert(result.error || 'An error occurred', 'error');
            }
        } catch (error) {
            showAlert('An error occurred', 'error');
        }
    }
    
    window.onclick = function(event) {
        const modal = document.getElementById('postModal');
        if (event.target == modal) closeModal();
    }
</script>

{% endblock %}