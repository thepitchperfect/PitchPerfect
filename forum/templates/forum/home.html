{% extends 'base.html' %}
{% load static %}

{% block title %}Soccer Forum{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'forum/css/forum.css' %}">
{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="forum-layout mt-2">
    <!-- MOBILE FILTER TOGGLE -->
    <div class="lg:hidden w-full flex justify-start mb-4 px-4">
        <button
            id="toggleFilterBtn"
            class="py-2 px-4 bg-[#fe8800] text-white rounded-md font-['Tektur'] font-semibold uppercase text-sm hover:bg-[#ffb054] transition"
        >
            Filters ▾
        </button>
    </div>

    <!-- Sidebar Filters -->
    <div id="filterSidebar" class="hidden lg:block">
        <aside class="lg:sticky lg:top-8 lg:h-[calc(100vh-2rem)] lg:w-56 w-full bg-white rounded-xl p-4 shadow-sm border border-[#ffd7aa] overflow-y-auto">
            <h3 class="font-['Tektur'] text-[#fe8800] text-lg font-bold mb-4 pb-3 border-b-4 border-[#ffd7aa]">FILTERS</h3>

            <form id="filterForm" class="space-y-4">
                <!-- Clubs Multi-Select with Search (Only Favorite Clubs) -->
                <div class="filter-group">
                <label class="block text-sm font-['Tektur'] font-semibold text-gray-700 mb-2">Filter by Your Clubs:</label>

                {% if user.is_authenticated %}
                    {% if user.is_staff %}
                    <input type="text" id="clubSearch" class="club-search w-full rounded-md border-2 border-[#ffd7aa] px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#fe8800]" placeholder="Search clubs...">
                    <div id="clubsMultiselect" class="clubs-multiselect mt-2 max-h-44 overflow-y-auto rounded-md border-2 border-[#ffd7aa] p-2">
                        {% for club in clubs %}
                        <div class="club-checkbox flex items-center gap-2 p-2 rounded hover:bg-[#fff6ea] cursor-pointer" data-club-name="{{ club.name|lower }}">
                            <input type="checkbox" name="clubs" value="{{ club.id }}" id="club-{{ club.id }}" class="w-4 h-4 text-[#fe8800] focus:ring-[#fe8800]" {% if club.id|stringformat:"s" in current_filters.clubs %}checked{% endif %}>
                            <label for="club-{{ club.id }}" class="text-sm text-gray-700">{{ club.name }}</label>
                        </div>
                        {% endfor %}
                    </div>

                    {% elif user_favorite_clubs %}
                    <input type="text" id="clubSearch" class="club-search w-full rounded-md border-2 border-[#ffd7aa] px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#fe8800]" placeholder="Search your clubs...">
                    <div id="clubsMultiselect" class="clubs-multiselect mt-2 max-h-44 overflow-y-auto rounded-md border-2 border-[#ffd7aa] p-2">
                        {% for club in user_favorite_clubs %}
                        <div class="club-checkbox flex items-center gap-2 p-2 rounded hover:bg-[#fff6ea] cursor-pointer" data-club-name="{{ club.name|lower }}">
                            <input type="checkbox" name="clubs" value="{{ club.id }}" id="club-{{ club.id }}" class="w-4 h-4 text-[#fe8800] focus:ring-[#fe8800]" {% if club.id|stringformat:"s" in current_filters.clubs %}checked{% endif %}>
                            <label for="club-{{ club.id }}" class="text-sm text-gray-700">{{ club.name }}</label>
                        </div>
                        {% endfor %}
                    </div>

                    {% else %}
                    <p class="text-sm text-gray-600 p-3 bg-[#ffd7aa30] rounded-md">
                        You haven't added any favorite clubs yet. Go to your Club Directory to add some!
                    </p>
                    {% endif %}
                {% else %}
                    <p class="text-sm text-gray-600 p-3 bg-[#ffd7aa30] rounded-md">
                    <a href="{% url 'main:login' %}" class="font-semibold text-[#fe8800]">Login</a> to filter by your clubs
                    </p>
                {% endif %}
            </div>

            <!-- Search -->
            <div class="filter-group">
            <label class="block text-sm font-['Tektur'] font-semibold text-gray-700 mb-2">Search:</label>
            <input type="text" name="search" id="searchInput" value="{{ current_filters.search|default:'' }}" placeholder="Search posts..." class="w-full rounded-md border-2 border-[#ffd7aa] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#fe8800]">
            </div>

            <!-- Filter actions -->
            <div class="filter-actions flex flex-col gap-2 mt-2">
            <button type="submit" class="btn btn-primary w-full py-2 rounded-md bg-gradient-to-br from-[#fe8800] to-[#ffb054] text-white font-['Tektur'] font-semibold uppercase text-sm hover:opacity-95 transition">
                Apply Filters
            </button>
            <button type="button" onclick="clearFilters()" class="btn btn-secondary w-full py-2 rounded-md bg-[#ffd7aa] text-[#333] font-['Tektur'] font-semibold uppercase text-sm hover:bg-[#ffb054] hover:text-white transition">
                Clear All
            </button>
            </div>
        </form>

            <!-- small spacer for bottom -->
            <div class="mt-4"></div>
        </aside>
    </div>


    <!-- Main Content -->
    <main class="flex-1 px-4 md:px-8 py-8 font-['Lato'] bg-[#fff6ea] min-h-screen">
        <!-- FORUM HEADER -->
        <div class="forum-header w-full mb-6 border-b-4 border-[#fe8800] pb-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <h1 class="forum-title font-['Orbitron'] text-[#fe8800] text-3xl sm:text-4xl font-extrabold uppercase tracking-wider">
            <span class="text-gray-900">DISCUSSION</span> FORUM
            </h1>

            {% if user.is_authenticated %}
            <div class="flex items-center gap-3">
                <button
                type="button"
                onclick="openCreateModal()"
                class="inline-flex items-center px-4 py-2 rounded-md font-['Tektur'] text-sm font-semibold uppercase bg-gradient-to-br from-[#fe8800] to-[#ffb054] text-white shadow-sm hover:opacity-95 transition"
                >
                CREATE POST
                </button>
            </div>
            {% else %}
            <p class="login-prompt text-sm text-gray-600">
                <a href="{% url 'main:login' %}" class="font-semibold text-[#fe8800] underline">Login</a>
                to create posts and join discussions
            </p>
            {% endif %}
        </div>
        </div>

        {% if news_posts %}
        <section class="news-carousel-section max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
        <div class="carousel-header flex items-center justify-between mb-4">
            <h2 class="carousel-title font-['Orbitron'] text-[#fe8800] text-2xl sm:text-3xl font-bold uppercase tracking-wide">
            Official News
            </h2>

            <div class="carousel-controls flex items-center gap-2">
            <button id="prevBtn" class="carousel-btn flex items-center justify-center w-10 h-10 rounded-full bg-[#fe8800] text-white shadow-sm hover:scale-105 transition disabled:opacity-50" onclick="prevSlide()">‹</button>
            <button id="nextBtn" class="carousel-btn flex items-center justify-center w-10 h-10 rounded-full bg-[#fe8800] text-white shadow-sm hover:scale-105 transition disabled:opacity-50" onclick="nextSlide()">›</button>
            </div>
        </div>

        <div class="news-carousel relative overflow-hidden bg-transparent rounded-lg">
            <div id="carouselTrack" class="carousel-track flex transition-transform duration-500 ease-in-out">
            {% for news in news_posts %}
                {% if forloop.first or forloop.counter0|divisibleby:3 %}
                <!-- start slide: grid with left large (2-row) + right column (2 stacked items) -->
                <div class="carousel-slide flex-shrink-0 w-full grid grid-cols-3 gap-4">
                {% endif %}

                {% comment %}
                Rendering logic per item in group of 3:
                    - first item (forloop.counter0 % 3 == 0) => large left (col-span-2 row-span-2)
                    - second item (else) => right-top (col-span-1)
                    - third item (forloop.counter % 3 == 0) => right-bottom (col-span-1)
                {% endcomment %}

                {% if forloop.counter0|divisibleby:3 %}
                <!-- LARGE LEFT CARD (spans two rows) -->
                <article
                    class="news-card large col-span-2 row-span-2 flex flex-col bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transform transition cursor-pointer"
                    onclick="window.location.href='{% url 'forum:post_detail' news.id %}'"
                >
                    {% if news.images.first %}
                    <img src="{{ news.images.first.image_url }}" alt="{{ news.title }}" class="w-full h-72 md:h-96 object-cover">
                    {% else %}
                    <div class="w-full h-72 md:h-96 bg-gradient-to-br from-[#ffd7aa] to-[#ffb054]"></div>
                    {% endif %}

                    <div class="p-4 flex flex-col gap-2 h-full">
                    <div class="news-clubs flex flex-wrap gap-2 mb-1">
                        {% for club in news.clubs.all %}
                        <span class="club-badge inline-flex items-center gap-2 bg-white px-2 py-1 rounded-md text-xs font-['Tektur']">
                            {% if club.logo_url %}
                            <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo w-4 h-4 object-contain">
                            {% endif %}
                            {{ club.name }}
                        </span>
                        {% endfor %}
                    </div>

                    <h3 class="news-title font-['Orbitron'] text-lg md:text-2xl font-bold text-gray-800 mb-1 leading-snug">
                        {{ news.title }}
                    </h3>

                    <div class="news-meta text-sm text-gray-500 flex flex-wrap gap-2 mb-2">
                        <span>Written by {{ news.author.username }}  | </span>
                        {% if news.updated_at and news.created_at and news.updated_at|date:'U' > news.created_at|date:'U' %}
                        <span>{{ news.updated_at|date:"M d, Y" }} | <em>Edited</em></span>
                        {% elif news.created_at %}
                        <span>{{ news.created_at|date:"M d, Y" }}</span>
                        {% else %}
                        <span>Unknown date</span>
                        {% endif %}
                    </div>

                    <p class="news-excerpt text-sm text-gray-700 line-clamp-4 md:line-clamp-6 text-justify">
                        {{ news.content|truncatewords:60 }}
                    </p>

                    <div class="news-footer mt-auto pt-3 border-t border-[#ffd7aa] flex items-center justify-between text-sm">
                        <span class="comment-count text-gray-600">{{ news.comments.count }} comments</span>
                        <span class="inline-flex items-center px-3 py-1 bg-gradient-to-br from-[#fe8800] to-[#ffb054] text-white rounded text-sm font-semibold">Read More →</span>
                    </div>
                    </div>
                </article>

                {% elif forloop.counter|divisibleby:3 %}
                <!-- RIGHT BOTTOM SMALL CARD -->
                <article
                    class="news-card small col-span-1 flex flex-col bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transform transition cursor-pointer"
                    onclick="window.location.href='{% url 'forum:post_detail' news.id %}'"
                >
                    {% if news.images.first %}
                    <img src="{{ news.images.first.image_url }}" alt="{{ news.title }}" class="w-full h-36 object-cover">
                    {% else %}
                    <div class="w-full h-36 bg-gradient-to-br from-[#ffd7aa] to-[#ffb054]"></div>
                    {% endif %}

                    <div class="p-3 flex flex-col gap-2 h-full">
                        <div class="news-clubs flex flex-wrap gap-2">
                        {% for club in news.clubs.all|slice:":2" %}
                            <span class="club-badge inline-flex items-center gap-1 bg-[#fffdfa] px-2 py-0.5 rounded text-[11px] font-['Tektur'] text-gray-700">
                            {% if club.logo_url %}
                                <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo w-4 h-4 object-contain">
                            {% endif %}
                            {{ club.name }}
                            </span>
                        {% endfor %}
                        </div>
                        <h4 class="font-['Orbitron'] text-sm font-bold text-gray-800">{{ news.title }}</h4>
                        <p class="news-excerpt text-xs text-gray-600 line-clamp-3 text-justify">{{ news.content|truncatewords:20 }}</p>
                        <div class="news-footer mt-auto pt-2 border-t border-[#ffd7aa] flex items-center justify-between text-xs">
                            <span class="comment-count text-gray-600">{{ news.comments.count }} comments</span>
                            <span class="text-[#fe8800] font-semibold text-xs">Read →</span>
                        </div>
                    </div>
                </article>

                {% else %}
                <!-- RIGHT TOP SMALL CARD (with club badge) -->
                <article
                class="news-card small col-span-1 flex flex-col bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transform transition cursor-pointer"
                onclick="window.location.href='{% url 'forum:post_detail' news.id %}'"
                >
                {% if news.images.first %}
                    <img src="{{ news.images.first.image_url }}" alt="{{ news.title }}" class="w-full h-36 object-cover">
                {% else %}
                    <div class="w-full h-36 bg-gradient-to-br from-[#ffd7aa] to-[#ffb054]"></div>
                {% endif %}

                <div class="p-3 flex flex-col gap-2 h-full">
                    <div class="news-clubs flex flex-wrap gap-2">
                    {% for club in news.clubs.all|slice:":2" %}
                        <span class="club-badge inline-flex items-center gap-1 bg-[#fffdfa] px-2 py-0.5 rounded text-[11px] font-['Tektur'] text-gray-700">
                        {% if club.logo_url %}
                            <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo w-4 h-4 object-contain">
                        {% endif %}
                        {{ club.name }}
                        </span>
                    {% endfor %}
                    </div>
                    <h4 class="font-['Orbitron'] text-sm font-bold text-gray-800">{{ news.title }}</h4>
                    <p class="news-excerpt text-xs text-gray-600 line-clamp-3 text-justify">{{ news.content|truncatewords:18 }}</p>
                    <div class="news-footer mt-auto pt-2 border-t border-[#ffd7aa] flex items-center justify-between text-xs">
                    <span class="comment-count text-gray-600">{{ news.comments.count }} comments</span>
                    <span class="text-[#fe8800] font-semibold text-xs">Read →</span>
                    </div>
                </div>
                </article>

                {% endif %}

                {% if forloop.counter|divisibleby:3 or forloop.last %}
                </div> <!-- end slide -->
                {% endif %}
            {% endfor %}
            </div>
        </div>

        <div id="carouselDots" class="carousel-dots mt-4 flex justify-center gap-2"></div>
        </section>
        {% endif %}

        <!-- LATEST DISCUSSIONS  -->
        <section class="forum-posts max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 bg-[#fff6ea] rounded-xl">
        <h2 class="text-2xl sm:text-3xl font-['Orbitron'] text-[#fe8800] font-bold uppercase tracking-wide mb-6">
            Latest Discussions
        </h2>

        <div class="flex flex-col gap-6">
            {% for post in page_obj %}
            <article class="bg-white border border-[#ffd7aa] rounded-xl shadow-sm hover:shadow-md transition overflow-hidden flex flex-col">
                <div class="flex flex-col md:flex-row p-5 gap-4 md:gap-6">
                
                <!-- Left Content -->
                <div class="flex-1 flex flex-col">
                    <!-- Club badges -->
                    <div class="flex flex-wrap gap-2 mb-2">
                    {% for club in post.clubs.all %}
                        <span class="inline-flex items-center gap-1 bg-[#fffdfa] px-2 py-0.5 rounded text-xs font-['Tektur'] text-gray-700">
                        {% if club.logo_url %}
                            <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="w-4 h-4 object-contain">
                        {% endif %}
                        {{ club.name }}
                        </span>
                    {% endfor %}
                    </div>

                    <!-- Title -->
                    <h3 class="text-lg sm:text-xl font-['Tektur'] font-semibold text-[#fe8800] leading-snug mb-1">
                    <a href="{% url 'forum:post_detail' post.id %}" class="hover:underline">
                        {{ post.title }}
                    </a>
                    </h3>

                    <!-- Author & date -->
                    <div class="text-xs text-gray-500 mb-3">
                            <span>{{ post.author.username }} | </span>
                            {% if post.updated_at and post.created_at and post.updated_at|date:'U' > post.created_at|date:'U' %}
                            <span>{{ post.updated_at|date:"M d, Y" }} | <em>Edited</em></span>
                            {% elif post.created_at %}
                            <span>{{ post.created_at|date:"M d, Y" }}</span>
                            {% else %}
                            <span>Unknown date</span>
                            {% endif %}
                    </div>

                    <!-- Image (mobile only) -->
                    {% if post.images.first %}
                    <div class="md:hidden w-full flex justify-center mb-3">
                        <img src="{{ post.images.first.image_url }}" alt="{{ post.title }}"
                            class="rounded-md w-full sm:w-3/4 object-cover border border-[#ffd7aa]" />
                    </div>
                    {% endif %}

                    <!-- Content -->
                    <p class="text-gray-700 text-sm leading-relaxed mb-2 line-clamp-4 text-justify">
                    {{ post.content|truncatewords:60 }}
                    </p>
                </div>

                <!-- Right Image (desktop only) -->
                {% if post.images.first %}
                    <div class="hidden md:flex md:items-start md:justify-end md:w-64 lg:w-72 pr-3">
                    <img src="{{ post.images.first.image_url }}" alt="{{ post.title }}"
                        class="rounded-md w-full object-cover border border-[#ffd7aa]" />
                    </div>
                {% endif %}
                </div>

                <!-- Footer -->
                <footer class="px-5 py-2 border-t border-[#ffd7aa] flex justify-between items-center text-sm text-gray-600 bg-[#fffdfa]"><!-- ↓ smaller py -->
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-comment text-[#fe8800]"></i>
                    <span>{{ post.comment_count }} comments</span>
                </div>
                <a href="{% url 'forum:post_detail' post.id %}"
                    class="text-[#fe8800] font-semibold hover:underline">
                    Read more →
                </a>
                </footer>
            </article>
            {% empty %}
            <p class="text-center text-gray-500 py-8">No discussions found.</p>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
            <div class="pagination flex justify-center items-center mt-8 gap-2 font-['Tektur']">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 rounded-md bg-[#ffd7aa] text-[#333] hover:bg-[#ffb054] transition">« Prev</a>
            {% else %}
                <span class="px-3 py-1 rounded-md bg-gray-200 text-gray-400 cursor-not-allowed">« Prev</span>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <span class="px-3 py-1 rounded-md bg-[#fe8800] text-white font-semibold">{{ num }}</span>
                {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                <a href="?page={{ num }}" class="px-3 py-1 rounded-md bg-[#ffd7aa] text-[#333] hover:bg-[#ffb054] transition">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 rounded-md bg-[#ffd7aa] text-[#333] hover:bg-[#ffb054] transition">Next »</a>
            {% else %}
                <span class="px-3 py-1 rounded-md bg-gray-200 text-gray-400 cursor-not-allowed">Next »</span>
            {% endif %}
            </div>
        {% endif %}
        </section>
    </main>
</div>

<!-- Create/Edit Post Modal -->
<div id="postModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Create Post</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        
        <form id="postForm">
            {% if user.is_staff %}
            <div class="form-group">
                <label>Post Type:</label>
                <select id="postType">
                    <option value="discussion">Discussion</option>
                    <option value="news">Official News</option>
                </select>
            </div>
            {% endif %}

            <div class="form-group">
                <label>Title:</label>
                <input type="text" id="postTitle" required placeholder="Enter post title">
            </div>

            <div class="form-group">
                <label>Content:</label>
                <textarea id="postContent" required placeholder="Share your thoughts..."></textarea>
            </div>

            <div class="form-group">
                <label>Tag Clubs (up to 3):</label>
                <div id="dynamicClubFields"></div>
                <small>You can tag up to 3 clubs. Remove a tag to add another.</small>
            </div>

            <div class="form-group">
                <label>Image URLs (optional):</label>
                <div class="image-inputs" id="imagesContainer">
                    <div class="image-input">
                        <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                        <input type="text" class="image-caption" placeholder="Caption">
                        <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addImageInput()" style="margin-top: 0.5rem;">
                    + Add Image
                </button>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggleFilterBtn');
        const sidebar = document.getElementById('filterSidebar');

        toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        sidebar.classList.toggle('block');
        });
    });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    let editingPostId = null;
    
    // Club Search Functionality
    const clubSearch = document.getElementById('clubSearch');
    if (clubSearch) {
        clubSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const checkboxes = document.querySelectorAll('.club-checkbox');
            
            checkboxes.forEach(checkbox => {
                const clubName = checkbox.getAttribute('data-club-name');
                if (clubName.includes(searchTerm)) {
                    checkbox.classList.remove('hidden');
                } else {
                    checkbox.classList.add('hidden');
                }
            });
        });
    }

    // --- Dynamic club tagging (max 3) ---
    const clubs = [
        {% for club in clubs %}
        {id: '{{ club.id }}', name: '{{ club.name }}', league: '{{ club.league.name }}'},
        {% endfor %}
    ];
    const dynamicClubFields = document.getElementById('dynamicClubFields');
    let clubTags = [];

    function renderClubFields() {
        dynamicClubFields.innerHTML = '';
        // Render tags
        clubTags.forEach((club, idx) => {
            const tag = document.createElement('span');
            tag.className = 'dynamic-club-tag';
            tag.dataset.id = club.id;
            // Add text node for club name
            tag.appendChild(document.createTextNode(club.name + ' - ' + club.league));
            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '×';
            removeBtn.className = 'remove-club-btn';
            removeBtn.onclick = function() {
                clubTags = clubTags.filter((_, i) => i !== idx);
                renderClubFields();
            };
            tag.appendChild(removeBtn);
            dynamicClubFields.appendChild(tag);
        });
        // Render new input if less than 3
        if (clubTags.length < 3) {
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Type to search clubs...';
            input.setAttribute('list', 'clubsDatalist');
            input.className = 'club-search-input';
            input.autocomplete = 'off';
            input.addEventListener('change', function(e) {
                const val = input.value.trim();
                if (!val) return;
                const match = clubs.find(c => (c.name + ' - ' + c.league) === val);
                if (match && !clubTags.some(t => t.id === match.id)) {
                    clubTags.push(match);
                    renderClubFields();
                }
                input.value = '';
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.dispatchEvent(new Event('change'));
                }
            });
            dynamicClubFields.appendChild(input);
        }
    }
    // Datalist for club search
    if (!document.getElementById('clubsDatalist')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'clubsDatalist';
        clubs.forEach(club => {
            const opt = document.createElement('option');
            opt.value = club.name + ' - ' + club.league;
            opt.dataset.id = club.id;
            datalist.appendChild(opt);
        });
        document.body.appendChild(datalist);
    }
    renderClubFields();

    // For edit: prepopulate clubTags if editing
    window.prefillClubTags = function(ids) {
        clubTags = clubs.filter(c => ids.includes(c.id));
        renderClubFields();
    }
    // Club search and tagging logic
    const clubSearchInput = document.getElementById('clubSearchInput');
    const clubsDatalist = document.getElementById('clubsDatalist');
    const selectedClubsContainer = document.getElementById('selectedClubsContainer');
    let selectedClubsSet = new Set();

    if (clubSearchInput && clubsDatalist && selectedClubsContainer) {
        clubSearchInput.addEventListener('change', function(e) {
            const inputValue = clubSearchInput.value.trim();
            if (!inputValue) return;
            // Find the option with this value
            const option = Array.from(clubsDatalist.options).find(opt => opt.value === inputValue);
            if (option && !selectedClubsSet.has(option.dataset.id)) {
                selectedClubsSet.add(option.dataset.id);
                const span = document.createElement('span');
                span.className = 'selected-club';
                span.dataset.id = option.dataset.id;
                span.textContent = option.value;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = '×';
                removeBtn.className = 'remove-club-btn';
                removeBtn.onclick = function() {
                    selectedClubsSet.delete(option.dataset.id);
                    span.remove();
                };
                span.appendChild(removeBtn);
                selectedClubsContainer.appendChild(span);
                clubSearchInput.value = '';
            }
        });
        // Optional: Add on Enter key
        clubSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clubSearchInput.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Carousel functionality
    let currentSlide = 0;
    const totalSlides = Math.ceil({{ news_posts.count }} / 3) || 1;
    let autoplayInterval;
    
    function updateCarousel() {
        const track = document.getElementById('carouselTrack');
        if (track) {
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            // Update dots
            const dots = document.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlide);
            });
            
            // Update button states
            document.getElementById('prevBtn').disabled = currentSlide === 0;
            document.getElementById('nextBtn').disabled = currentSlide === totalSlides - 1;
        }
    }
    
    function nextSlide() {
        if (currentSlide < totalSlides - 1) {
            currentSlide++;
            updateCarousel();
            resetAutoplay();
        }
    }
    
    function prevSlide() {
        if (currentSlide > 0) {
            currentSlide--;
            updateCarousel();
            resetAutoplay();
        }
    }
    
    function goToSlide(index) {
        currentSlide = index;
        updateCarousel();
        resetAutoplay();
    }
    
    function startAutoplay() {
        autoplayInterval = setInterval(() => {
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
            } else {
                currentSlide = 0;
            }
            updateCarousel();
        }, 8000); // Auto-advance every 5 seconds
    }
    
    function resetAutoplay() {
        clearInterval(autoplayInterval);
        startAutoplay();
    }
    
    // Initialize carousel
    if (document.getElementById('carouselTrack')) {
        // Create dots
        const dotsContainer = document.getElementById('carouselDots');
        for (let i = 0; i < totalSlides; i++) {
            const dot = document.createElement('div');
            dot.className = 'carousel-dot';
            if (i === 0) dot.classList.add('active');
            dot.onclick = () => goToSlide(i);
            dotsContainer.appendChild(dot);
        }
        
        // Start autoplay
        startAutoplay();
        
        // Pause on hover
        const carousel = document.querySelector('.news-carousel');
        carousel.addEventListener('mouseenter', () => clearInterval(autoplayInterval));
        carousel.addEventListener('mouseleave', () => startAutoplay());
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        document.getElementById('alert-container').appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
    }
    
    // Filter handling
    document.getElementById('filterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const params = new URLSearchParams();
        
        // Get all checked clubs
        const clubs = [];
        document.querySelectorAll('input[name="clubs"]:checked').forEach(cb => {
            clubs.push(cb.value);
        });
        clubs.forEach(club => params.append('clubs', club));
        
        const league = formData.get('league');
        const search = formData.get('search');
        
        if (league) params.append('league', league);
        if (search) params.append('search', search);
        
        window.location.href = '{% url "forum:forum_home" %}?' + params.toString();
    });
    
    function clearFilters() {
        window.location.href = '{% url "forum:forum_home" %}';
    }
    
    // Modal functions
    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Create Post';
        document.getElementById('postForm').reset();
        editingPostId = null;
        
        // Reset image inputs
        document.getElementById('imagesContainer').innerHTML = `
            <div class="image-input">
                <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                <input type="text" class="image-caption" placeholder="Caption">
                <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
            </div>
        `;
        
        document.getElementById('postModal').style.display = 'block';
        renderClubFields();
    }
    
    function openEditModal(postId) {
        editingPostId = postId;
        document.getElementById('modalTitle').textContent = 'Edit Post';
        
        // Fetch post data via AJAX
        fetch(`/forum/api/post/${postId}/data/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const post = data.post;
                
                // Populate form fields
                document.getElementById('postTitle').value = post.title;
                document.getElementById('postContent').value = post.content;
                
                // Set post type if admin
                {% if user.is_staff %}
                if (document.getElementById('postType')) {
                    document.getElementById('postType').value = post.post_type;
                }
                {% endif %}
                
                // Select clubs
                const clubsSelect = document.getElementById('postClubs');
                if (clubsSelect) {
                    Array.from(clubsSelect.options).forEach(option => {
                        option.selected = post.club_ids.includes(option.value);
                    });
                }
                
                // Select league
                const leagueSelect = document.getElementById('postLeague');
                if (leagueSelect) {
                    leagueSelect.value = post.league_id || '';
                }
                
                // Populate images
                const imagesContainer = document.getElementById('imagesContainer');
                imagesContainer.innerHTML = '';
                
                if (post.images && post.images.length > 0) {
                    post.images.forEach(img => {
                        const div = document.createElement('div');
                        div.className = 'image-input';
                        div.innerHTML = `
                            <input type="url" class="image-url" placeholder="https://example.com/image.jpg" value="${img.url}">
                            <input type="text" class="image-caption" placeholder="Caption" value="${img.caption || ''}">
                            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)">Remove Image</button>
                        `;
                        imagesContainer.appendChild(div);
                    });
                } else {
                    // Add empty image input
                    imagesContainer.innerHTML = `
                        <div class="image-input">
                            <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
                            <input type="text" class="image-caption" placeholder="Caption">
                            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)" style="display:none;">Remove Image</button>
                        </div>
                    `;
                }
                
                // Show modal
                document.getElementById('postModal').style.display = 'block';
                prefillClubTags(post.club_ids);
                renderClubFields();
            } else {
                showAlert(data.error || 'Failed to load post data', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to load post data: ' + error.message, 'error');
        });
    }
    
    function closeModal() {
        document.getElementById('postModal').style.display = 'none';
    }
    
    function addImageInput() {
        const container = document.getElementById('imagesContainer');
        const div = document.createElement('div');
        div.className = 'image-input';
        div.innerHTML = `
            <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
            <input type="text" class="image-caption" placeholder="Caption">
            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)">Remove Image</button>
        `;
        container.appendChild(div);
    }
    
    function removeImageInput(btn) {
        btn.closest('.image-input').remove();
    }
    
    // Form submission
    document.getElementById('postForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Collect images
        const images = [];
        document.querySelectorAll('.image-input').forEach(input => {
            const url = input.querySelector('.image-url').value;
            const caption = input.querySelector('.image-caption').value;
            if (url) images.push({ url, caption });
        });
        
        // Collect selected clubs from dynamic fields
        const selectedClubs = Array.from(document.querySelectorAll('.dynamic-club-tag'))
            .map(el => el.dataset.id);
    
        
        const data = {
            title: document.getElementById('postTitle').value,
            content: document.getElementById('postContent').value,
            club_ids: selectedClubs,
            league_id: document.getElementById('postLeague') ? document.getElementById('postLeague').value : null,
            images: images
        };
        
        {% if user.is_staff %}
        data.post_type = document.getElementById('postType').value;
        {% endif %}
        
        const url = editingPostId 
            ? `/forum/api/post/${editingPostId}/update/`
            : '/forum/api/post/create/';
        const method = editingPostId ? 'PUT' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(editingPostId ? 'Post updated!' : 'Post created!', 'success');
                closeModal();
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(result.error || 'An error occurred', 'error');
            }
        } catch (error) {
            showAlert('An error occurred', 'error');
        }
    });
    
    async function deletePost(id) {
        if (!confirm('Are you sure you want to delete this post?')) return;
        
        try {
            const response = await fetch(`/forum/api/post/${id}/delete/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Post deleted!', 'success');
                document.getElementById(`post-${id}`).remove();
            } else {
                showAlert(result.error || 'An error occurred', 'error');
            }
        } catch (error) {
            showAlert('An error occurred', 'error');
        }
    }
    
    window.onclick = function(event) {
        const modal = document.getElementById('postModal');
        if (event.target == modal) closeModal();
    }
</script>

{% endblock %}