{% extends 'base.html' %}
{% load static %}

{% block title %}Pitch Perfect - Forum{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="forum-layout mt-2 flex gap-6">
  <!-- MOBILE & DESKTOP LAYOUT -->
  <div class="w-full flex flex-col lg:flex-row gap-0 lg:gap-6">
    <!-- MOBILE FILTER TOGGLE -->
    <div class="lg:hidden w-full flex flex-col items-start mb-4 px-4">
      <button
        id="toggleFilterBtn"
        class="py-2 px-4 bg-[#fe8800] text-white rounded-md font-['Tektur'] font-semibold uppercase text-sm hover:bg-[#ffb054] transition"
        style="align-self: flex-start;"
      >
        Filters ▾
      </button>
    </div>

    <!-- Sidebar Filters -->
    <div id="filterSidebar" class="hidden lg:block">
      <aside class="lg:sticky lg:top-8 lg:h-[calc(100vh-2rem)] lg:w-56 lg:ml-4 w-full bg-white rounded-xl p-4 shadow-sm border border-[#f4f4f4] overflow-y-auto">
        <h3 class="font-['Tektur'] text-[#fe8800] text-lg font-bold mb-4 pb-3 border-b-4 border-[#ffd7aa]">FILTERS</h3>

        <form id="filterForm" class="space-y-4">
                <!-- Clubs Multi-Select with Search (Only Favorite Clubs) -->
                <div class="filter-group">
                <label class="block text-sm font-['Tektur'] font-semibold text-gray-700 mb-2">Filter by Your Clubs:</label>

                {% if user.is_authenticated %}
                    {% if user.is_staff %}
                    <input type="text" id="clubSearch" class="club-search w-full rounded-md border-2 border-[#ffd7aa] px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#fe8800]" placeholder="Search clubs...">
                    <div id="clubsMultiselect" class="clubs-multiselect mt-2 max-h-44 overflow-y-auto rounded-md border-2 border-[#ffd7aa] p-2">
                        {% for club in clubs %}
                        <div class="club-checkbox flex items-center gap-2 p-2 rounded hover:bg-[#fff6ea] cursor-pointer" data-club-name="{{ club.name|lower }}">
                            <input type="checkbox" name="clubs" value="{{ club.id }}" id="club-{{ club.id }}" class="w-4 h-4 text-[#fe8800] focus:ring-[#fe8800]" {% if club.id|stringformat:"s" in current_filters.clubs %}checked{% endif %}>
                            <label for="club-{{ club.id }}" class="text-sm text-gray-700">{{ club.name }}</label>
                        </div>
                        {% endfor %}
                    </div>

                    {% elif user_favorite_clubs %}
                    <input type="text" id="clubSearch" class="club-search w-full rounded-md border-2 border-[#ffd7aa] px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#fe8800]" placeholder="Search your clubs...">
                    <div id="clubsMultiselect" class="clubs-multiselect mt-2 max-h-44 overflow-y-auto rounded-md border-2 border-[#ffd7aa] p-2">
                        {% for club in user_favorite_clubs %}
                        <div class="club-checkbox flex items-center gap-2 p-2 rounded hover:bg-[#fff6ea] cursor-pointer" data-club-name="{{ club.name|lower }}">
                            <input type="checkbox" name="clubs" value="{{ club.id }}" id="club-{{ club.id }}" class="w-4 h-4 text-[#fe8800] focus:ring-[#fe8800]" {% if club.id|stringformat:"s" in current_filters.clubs %}checked{% endif %}>
                            <label for="club-{{ club.id }}" class="text-sm text-gray-700">{{ club.name }}</label>
                        </div>
                        {% endfor %}
                    </div>

                    {% else %}
                    <p class="text-sm text-gray-600 p-3 bg-[#ffd7aa30] rounded-md">
                        You haven't added any favorite clubs yet. Go to your Club Directory to add some!
                    </p>
                    {% endif %}
                {% else %}
                    <p class="text-sm text-gray-600 p-3 bg-[#ffd7aa30] rounded-md">
                    <a href="{% url 'main:login' %}" class="font-semibold text-[#fe8800]">Login</a> to filter by your clubs
                    </p>
                {% endif %}
            </div>

            <!-- Search -->
            <div class="filter-group">
            <label class="block text-sm font-['Tektur'] font-semibold text-gray-700 mb-2">Search:</label>
            <input type="text" name="search" id="searchInput" value="{{ current_filters.search|default:'' }}" placeholder="Search posts..." class="w-full rounded-md border-2 border-[#ffd7aa] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#fe8800]">
            </div>

            <!-- Filter actions -->
            <div class="filter-actions flex flex-col gap-2 mt-2">
            <button type="submit" class="btn btn-primary w-full py-2 rounded-md bg-gradient-to-br from-[#fe8800] to-[#ffb054] text-white font-['Tektur'] font-semibold uppercase text-sm hover:opacity-95 transition">
                Apply Filters
            </button>
            <button type="button" onclick="clearFilters()" class="btn btn-secondary w-full py-2 rounded-md bg-[#ffd7aa] text-[#333] font-['Tektur'] font-semibold uppercase text-sm hover:bg-[#ffb054] hover:text-white transition">
                Clear All
            </button>
            </div>
        </form>

            <!-- small spacer for bottom -->
            <div class="mt-4"></div>
        </aside>
    </div>


    <!-- Main Content -->
    <main class="flex-1 px-4 md:px-8 py-8 font-['Lato'] bg-[#fff6ea] min-h-screen">
        <!-- FORUM HEADER -->
        <div class="forum-header w-full mb-6 border-b-4 border-[#fe8800] pb-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <h1 class="forum-title font-['Orbitron'] text-[#fe8800] text-3xl sm:text-4xl font-extrabold uppercase tracking-wider">
            <span class="text-gray-900">DISCUSSION</span> FORUM
            </h1>

            {% if user.is_authenticated %}
            <div class="flex items-center gap-3">
                <button
                type="button"
                onclick="openCreateModal()"
                class="inline-flex items-center px-4 py-2 rounded-md font-['Tektur'] text-sm font-semibold uppercase bg-gradient-to-br from-[#fe8800] to-[#ffb054] text-white shadow-sm hover:opacity-95 transition"
                >
                CREATE POST
                </button>
            </div>
            {% else %}
            <p class="login-prompt text-sm text-gray-600">
                <a href="{% url 'main:login' %}" class="font-semibold text-[#fe8800] underline">Login</a>
                to create posts and join discussions
            </p>
            {% endif %}
        </div>
        </div>

        {% if news_posts %}
        <section class="news-carousel-section max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
        <div class="carousel-header flex items-center justify-between mb-4">
            <h2 class="carousel-title font-['Orbitron'] text-[#fe8800] text-2xl sm:text-3xl font-bold uppercase tracking-wide">
            Official News
            </h2>

            <div class="carousel-controls flex items-center gap-2">
            <button id="prevBtn" class="carousel-btn flex items-center justify-center w-10 h-10 rounded-full bg-[#fe8800] text-white shadow-sm hover:scale-105 transition disabled:opacity-50" onclick="prevSlide()">‹</button>
            <button id="nextBtn" class="carousel-btn flex items-center justify-center w-10 h-10 rounded-full bg-[#fe8800] text-white shadow-sm hover:scale-105 transition disabled:opacity-50" onclick="nextSlide()">›</button>
            </div>
        </div>

        <div class="news-carousel relative overflow-hidden bg-transparent rounded-lg">
            <div id="carouselTrack" class="carousel-track flex transition-transform duration-500 ease-in-out">
            {% for news in news_posts %}
                {% if forloop.first or forloop.counter0|divisibleby:3 %}
                <!-- start slide -->
                <div class="carousel-slide flex-shrink-0 w-full grid grid-cols-3 gap-4">
                {% endif %}

                {% comment %}
                Rendering logic per item in group of 3:
                    - first item (forloop.counter0 % 3 == 0) => large left (col-span-2 row-span-2)
                    - second item (else) => right-top (col-span-1)
                    - third item (forloop.counter % 3 == 0) => right-bottom (col-span-1)
                {% endcomment %}

                {% if forloop.counter0|divisibleby:3 %}
                <!-- LARGE LEFT CARD  -->
                <article
                    class="news-card large col-span-2 row-span-2 flex flex-col bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transform transition cursor-pointer"
                    onclick="window.location.href='{% url 'forum:post_detail' news.id %}'"
                >
                    {% if news.images.first %}
                    <img src="{{ news.images.first.image_url }}" alt="{{ news.title }}" class="w-full h-72 md:h-96 object-cover">
                    {% else %}
                    <div class="w-full h-72 md:h-96 bg-gradient-to-br from-[#ffd7aa] to-[#ffb054]"></div>
                    {% endif %}

                    <div class="p-4 flex flex-col gap-2 h-full">
                    <div class="news-clubs flex flex-wrap gap-2 mb-1">
                        {% for club in news.clubs.all %}
                        <span class="club-badge inline-flex items-center gap-2 bg-white px-2 py-1 rounded-md text-xs font-['Tektur']">
                            {% if club.logo_url %}
                            <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo w-4 h-4 object-contain">
                            {% endif %}
                            {{ club.name }}
                        </span>
                        {% endfor %}
                    </div>

                    <h3 class="news-title font-['Orbitron'] text-lg md:text-2xl font-bold text-gray-800 mb-1 leading-snug">
                        {{ news.title }}
                    </h3>

                    <div class="news-meta text-sm text-gray-500 flex flex-wrap gap-2 mb-2">
                        <span>Written by {{ news.author.username }}  | </span>
                        {% if news.updated_at and news.created_at and news.updated_at|date:'U' > news.created_at|date:'U' %}
                        <span>{{ news.updated_at|date:"M d, Y" }} | <em>Edited</em></span>
                        {% elif news.created_at %}
                        <span>{{ news.created_at|date:"M d, Y" }}</span>
                        {% else %}
                        <span>Unknown date</span>
                        {% endif %}
                    </div>

                    <p class="news-excerpt text-sm text-gray-700 line-clamp-4 md:line-clamp-6 text-justify">
                        {{ news.content|truncatewords:60 }}
                    </p>

                    <div class="news-footer mt-auto pt-3 border-t border-[#ffd7aa] flex items-center justify-between text-sm">
                        <span class="comment-count text-gray-600">{{ news.comments.count }} comments</span>
                        <span class="inline-flex items-center px-3 py-1 bg-gradient-to-br from-[#fe8800] to-[#ffb054] text-white rounded text-sm font-semibold">Read More →</span>
                    </div>
                    </div>
                </article>

                {% elif forloop.counter|divisibleby:3 %}
                <!-- RIGHT BOTTOM SMALL CARD -->
                <article
                    class="news-card small col-span-1 flex flex-col bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transform transition cursor-pointer"
                    onclick="window.location.href='{% url 'forum:post_detail' news.id %}'"
                >
                    {% if news.images.first %}
                    <img src="{{ news.images.first.image_url }}" alt="{{ news.title }}" class="w-full h-36 object-cover">
                    {% else %}
                    <div class="w-full h-36 bg-gradient-to-br from-[#ffd7aa] to-[#ffb054]"></div>
                    {% endif %}

                    <div class="p-3 flex flex-col gap-2 h-full">
                        <div class="news-clubs flex flex-wrap gap-2">
                        {% for club in news.clubs.all|slice:":2" %}
                            <span class="club-badge inline-flex items-center gap-1 bg-[#fffdfa] px-2 py-0.5 rounded text-[11px] font-['Tektur'] text-gray-700">
                            {% if club.logo_url %}
                                <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo w-4 h-4 object-contain">
                            {% endif %}
                            {{ club.name }}
                            </span>
                        {% endfor %}
                        </div>
                        <h4 class="font-['Orbitron'] text-sm font-bold text-gray-800">{{ news.title }}</h4>
                        <p class="news-excerpt text-xs text-gray-600 line-clamp-3 text-justify">{{ news.content|truncatewords:20 }}</p>
                        <div class="news-footer mt-auto pt-2 border-t border-[#ffd7aa] flex items-center justify-between text-xs">
                            <span class="comment-count text-gray-600">{{ news.comments.count }} comments</span>
                            <span class="text-[#fe8800] font-semibold text-xs">Read →</span>
                        </div>
                    </div>
                </article>

                {% else %}
                <!-- RIGHT TOP SMALL CARD  -->
                <article
                class="news-card small col-span-1 flex flex-col bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transform transition cursor-pointer"
                onclick="window.location.href='{% url 'forum:post_detail' news.id %}'"
                >
                {% if news.images.first %}
                    <img src="{{ news.images.first.image_url }}" alt="{{ news.title }}" class="w-full h-36 object-cover">
                {% else %}
                    <div class="w-full h-36 bg-gradient-to-br from-[#ffd7aa] to-[#ffb054]"></div>
                {% endif %}

                <div class="p-3 flex flex-col gap-2 h-full">
                    <div class="news-clubs flex flex-wrap gap-2">
                    {% for club in news.clubs.all|slice:":2" %}
                        <span class="club-badge inline-flex items-center gap-1 bg-[#fffdfa] px-2 py-0.5 rounded text-[11px] font-['Tektur'] text-gray-700">
                        {% if club.logo_url %}
                            <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="club-logo w-4 h-4 object-contain">
                        {% endif %}
                        {{ club.name }}
                        </span>
                    {% endfor %}
                    </div>
                    <h4 class="font-['Orbitron'] text-sm font-bold text-gray-800">{{ news.title }}</h4>
                    <p class="news-excerpt text-xs text-gray-600 line-clamp-3 text-justify">{{ news.content|truncatewords:18 }}</p>
                    <div class="news-footer mt-auto pt-2 border-t border-[#ffd7aa] flex items-center justify-between text-xs">
                    <span class="comment-count text-gray-600">{{ news.comments.count }} comments</span>
                    <span class="text-[#fe8800] font-semibold text-xs">Read →</span>
                    </div>
                </div>
                </article>

                {% endif %}

                {% if forloop.counter|divisibleby:3 or forloop.last %}
                </div>
                {% endif %}
            {% endfor %}
            </div>
        </div>

        <div id="carouselDots" class="carousel-dots mt-4 flex justify-center gap-2"></div>
        </section>
        {% endif %}

        <!-- LATEST DISCUSSIONS  -->
        <section class="forum-posts max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 bg-[#fff6ea] rounded-xl">
        <h2 class="text-2xl sm:text-3xl font-['Orbitron'] text-[#fe8800] font-bold uppercase tracking-wide mb-6">
            Latest Discussions
        </h2>

        <div class="flex flex-col gap-6">
            {% for post in page_obj %}
            <article class="bg-white border border-[#ffd7aa] rounded-xl shadow-sm hover:shadow-md transition overflow-hidden flex flex-col">
                <div class="flex flex-col md:flex-row p-5 gap-4 md:gap-6">
                
                <!-- Left Content -->
                <div class="flex-1 flex flex-col">
                    <!-- Club badges -->
                    <div class="flex flex-wrap gap-2 mb-2">
                    {% for club in post.clubs.all %}
                        <span class="inline-flex items-center gap-1 bg-[#fffdfa] px-2 py-0.5 rounded text-xs font-['Tektur'] text-gray-700">
                        {% if club.logo_url %}
                            <img src="{{ club.logo_url }}" alt="{{ club.name }}" class="w-4 h-4 object-contain">
                        {% endif %}
                        {{ club.name }}
                        </span>
                    {% endfor %}
                    </div>

                    <!-- Title -->
                    <h3 class="text-lg sm:text-xl font-['Tektur'] font-semibold text-[#fe8800] leading-snug mb-1">
                    <a href="{% url 'forum:post_detail' post.id %}" class="hover:underline">
                        {{ post.title }}
                    </a>
                    </h3>

                    <!-- Author & date -->
                    <div class="text-xs text-gray-500 mb-3">
                            <span>{{ post.author.username }} | </span>
                            {% if post.updated_at and post.created_at and post.updated_at|date:'U' > post.created_at|date:'U' %}
                            <span>{{ post.updated_at|date:"M d, Y" }} | <em>Edited</em></span>
                            {% elif post.created_at %}
                            <span>{{ post.created_at|date:"M d, Y" }}</span>
                            {% else %}
                            <span>Unknown date</span>
                            {% endif %}
                    </div>

                    <!-- Image (mobile only) -->
                    {% if post.images.first %}
                    <div class="md:hidden w-full flex justify-center mb-3">
                        <img src="{{ post.images.first.image_url }}" alt="{{ post.title }}"
                            class="rounded-md w-full sm:w-3/4 object-cover border border-[#ffd7aa]" />
                    </div>
                    {% endif %}

                    <!-- Content -->
                    <p class="text-gray-700 text-sm leading-relaxed mb-2 line-clamp-4 text-justify">
                    {{ post.content|truncatewords:60 }}
                    </p>
                </div>

                <!-- Right Image (desktop only) -->
                {% if post.images.first %}
                    <div class="hidden md:flex md:items-start md:justify-end md:w-64 lg:w-72 pr-3">
                    <img src="{{ post.images.first.image_url }}" alt="{{ post.title }}"
                        class="rounded-md w-full object-cover border border-[#ffd7aa]" />
                    </div>
                {% endif %}
                </div>

                <!-- Footer -->
                <footer class="px-5 py-2 border-t border-[#ffd7aa] flex justify-between items-center text-sm text-gray-600 bg-[#fffdfa]"><!-- ↓ smaller py -->
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-comment text-[#fe8800]"></i>
                    <span>{{ post.comment_count }} comments</span>
                </div>
                <a href="{% url 'forum:post_detail' post.id %}"
                    class="text-[#fe8800] font-semibold hover:underline">
                    Read more →
                </a>
                </footer>
            </article>
            {% empty %}
            <p class="text-center text-gray-500 py-8">No discussions found.</p>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
            <div class="pagination flex justify-center items-center mt-8 gap-2 font-['Tektur']">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 rounded-md bg-[#ffd7aa] text-[#333] hover:bg-[#ffb054] transition">« Prev</a>
            {% else %}
                <span class="px-3 py-1 rounded-md bg-gray-200 text-gray-400 cursor-not-allowed">« Prev</span>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <span class="px-3 py-1 rounded-md bg-[#fe8800] text-white font-semibold">{{ num }}</span>
                {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                <a href="?page={{ num }}" class="px-3 py-1 rounded-md bg-[#ffd7aa] text-[#333] hover:bg-[#ffb054] transition">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 rounded-md bg-[#ffd7aa] text-[#333] hover:bg-[#ffb054] transition">Next »</a>
            {% else %}
                <span class="px-3 py-1 rounded-md bg-gray-200 text-gray-400 cursor-not-allowed">Next »</span>
            {% endif %}
            </div>
        {% endif %}
        </section>
    </main>
</div>

<!-- CREATE POST MODAL (HYBRID) -->
<div id="createPostModal" class="fixed inset-0 z-50 hidden bg-black/50 p-4">
  <div class="mx-auto max-w-2xl w-full bg-[#f4f4f4] rounded-xl shadow-xl overflow-hidden max-h-[90vh] flex flex-col">
    <!-- Header -->
    <div class="flex items-start justify-between p-4 border-b border-[#ffd7aa]">
      <h3 class="text-lg sm:text-2xl font-['Orbitron'] text-[#fe8800]">Create New Post</h3>
      <button aria-label="Close" onclick="closeModal()" class="text-2xl text-gray-700">&times;</button>
    </div>

    <!-- Body  -->
    <div class="p-4 overflow-y-auto">
      <form id="postForm" method="post" class="space-y-4">
        {% csrf_token %}

        <!-- Render core fields from the Django form  -->
        <div>
          {{ form.title.label_tag }}
          {{ form.title }}
          {% if form.title.errors %}<div class="text-red-600 text-sm">{{ form.title.errors }}</div>{% endif %}
        </div>

        <div>
          {{ form.post_type.label_tag }}
          {{ form.post_type }}
          {% if form.post_type.errors %}<div class="text-red-600 text-sm">{{ form.post_type.errors }}</div>{% endif %}
        </div>

        <div>
          {{ form.content.label_tag }}
          {{ form.content }}
          {% if form.content.errors %}<div class="text-red-600 text-sm">{{ form.content.errors }}</div>{% endif %}
        </div>

        <!-- Clubs: search + dropdown + tag chips (max 3) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Clubs</label>
            <div class="relative">
                <input id="clubSearchInput" type="text" placeholder="Search clubs..." class="w-full rounded border border-[#ffd7aa] px-3 py-2 mb-2" autocomplete="off" />
                <div id="clubDropdown" class="absolute left-0 right-0 bg-white border rounded shadow max-h-44 overflow-auto hidden z-50"></div>
            </div>

          <div id="selectedClubs" class="flex flex-wrap gap-2 mb-2 mt-2"></div>

          <div id="clubHelper" class="text-xs text-gray-500">You may select up to <strong>3</strong> clubs.</div>

          <!-- Hidden container inside form where selected club inputs will be appended -->
          <div id="clubHiddenInputs" aria-hidden="true"></div>

          <!-- Hidden source list of clubs for JS to use (not visible) -->
          <div id="allClubsData" class="hidden">
            {% for club in clubs %}
              <div class="club-data" data-id="{{ club.id }}" data-name="{{ club.name }}"></div>
            {% endfor %}
          </div>
        </div>

        <!-- Image URL + caption pairs (dynamic) -->
        <div>
          <label class="block text-sm font-semibold mb-1">Images (URL + caption)</label>
          <p class="text-xs text-gray-500 mb-2">Add image URLs and captions. New images will be appended to the post.</p>

          <div id="imagesList" class="space-y-2">
            <!-- template row (cloned by JS) -->
            <div id="imageRowTemplate" class="flex gap-2 items-start" style="display:none;">
              <input type="url" name="image_urls" placeholder="https://example.com/img.jpg" class="flex-1 rounded border border-[#ffd7aa] px-2 py-1" />
              <input type="text" name="image_captions" placeholder="Caption (optional)" class="w-44 rounded border border-[#ffd7aa] px-2 py-1" />
              <button type="button" class="text-red-600" onclick="removeImageRow(this)">✕</button>
            </div>
          </div>

          <div class="mt-2">
            <button type="button" id="addImageRowBtn" class="px-3 py-1 bg-[#ffd7aa] rounded hover:bg-[#ffb054]">Add image</button>
          </div>
        </div>

        <!-- error area -->
        <div id="postFormErrors" class="text-sm text-red-600"></div>

        <!-- Actions -->
        <div class="flex justify-end gap-3 pt-3 border-t border-[#ffd7aa] mt-2">
          <button type="button" onclick="closeModal()" class="px-3 py-2 rounded bg-gray-300">Cancel</button>
          <button id="submitPostBtn" type="button" class="px-4 py-2 rounded bg-[#fe8800] text-white">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggleFilterBtn');
        const sidebar = document.getElementById('filterSidebar');

        toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        sidebar.classList.toggle('block');
        });
    });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    let editingPostId = null;
    
    // Club Search Functionality
    const clubSearch = document.getElementById('clubSearch');
    if (clubSearch) {
        clubSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const checkboxes = document.querySelectorAll('.club-checkbox');
            
            checkboxes.forEach(checkbox => {
                const clubName = checkbox.getAttribute('data-club-name');
                if (clubName.includes(searchTerm)) {
                    checkbox.classList.remove('hidden');
                } else {
                    checkbox.classList.add('hidden');
                }
            });
        });
    }

    const clubs = [
        {% for club in clubs %}
        {id: '{{ club.id }}', name: '{{ club.name }}', league: '{{ club.league.name }}'},
        {% endfor %}
    ];

    // Datalist for club search
    if (!document.getElementById('clubsDatalist')) {
        const datalist = document.createElement('datalist');
        datalist.id = 'clubsDatalist';
        clubs.forEach(club => {
            const opt = document.createElement('option');
            opt.value = club.name + ' - ' + club.league;
            opt.dataset.id = club.id;
            datalist.appendChild(opt);
        });
        document.body.appendChild(datalist);
    }

    // Club search and tagging logic
    const clubSearchInput = document.getElementById('clubSearchInput');
    const clubsDatalist = document.getElementById('clubsDatalist');
    const selectedClubsContainer = document.getElementById('selectedClubsContainer');
    let selectedClubsSet = new Set();

    if (clubSearchInput && clubsDatalist && selectedClubsContainer) {
        clubSearchInput.addEventListener('change', function(e) {
            const inputValue = clubSearchInput.value.trim();
            if (!inputValue) return;
            // Find the option with this value
            const option = Array.from(clubsDatalist.options).find(opt => opt.value === inputValue);
            if (option && !selectedClubsSet.has(option.dataset.id)) {
                selectedClubsSet.add(option.dataset.id);
                const span = document.createElement('span');
                span.className = 'selected-club';
                span.dataset.id = option.dataset.id;
                span.textContent = option.value;
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = '×';
                removeBtn.className = 'remove-club-btn';
                removeBtn.onclick = function() {
                    selectedClubsSet.delete(option.dataset.id);
                    span.remove();
                };
                span.appendChild(removeBtn);
                selectedClubsContainer.appendChild(span);
                clubSearchInput.value = '';
            }
        });

        clubSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clubSearchInput.dispatchEvent(new Event('change'));
            }
        });
    }
    
    // Carousel functionality
    let currentSlide = 0;
    const totalSlides = Math.ceil({{ news_posts.count }} / 3) || 1;
    let autoplayInterval;
    
    function updateCarousel() {
        const track = document.getElementById('carouselTrack');
        if (track) {
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            // Update dots
            const dots = document.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSlide);
            });
            
            // Update button states
            document.getElementById('prevBtn').disabled = currentSlide === 0;
            document.getElementById('nextBtn').disabled = currentSlide === totalSlides - 1;
        }
    }
    
    function nextSlide() {
        if (currentSlide < totalSlides - 1) {
            currentSlide++;
            updateCarousel();
            resetAutoplay();
        }
    }
    
    function prevSlide() {
        if (currentSlide > 0) {
            currentSlide--;
            updateCarousel();
            resetAutoplay();
        }
    }
    
    function goToSlide(index) {
        currentSlide = index;
        updateCarousel();
        resetAutoplay();
    }
    
    function startAutoplay() {
        autoplayInterval = setInterval(() => {
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
            } else {
                currentSlide = 0;
            }
            updateCarousel();
        }, 8000); 
    }
    
    function resetAutoplay() {
        clearInterval(autoplayInterval);
        startAutoplay();
    }
    
    // Initialize carousel
    if (document.getElementById('carouselTrack')) {
        // Create dots
        const dotsContainer = document.getElementById('carouselDots');
        for (let i = 0; i < totalSlides; i++) {
            const dot = document.createElement('div');
            dot.className = 'carousel-dot';
            if (i === 0) dot.classList.add('active');
            dot.onclick = () => goToSlide(i);
            dotsContainer.appendChild(dot);
        }
        
        // Start autoplay
        startAutoplay();
        
        // Pause on hover
        const carousel = document.querySelector('.news-carousel');
        carousel.addEventListener('mouseenter', () => clearInterval(autoplayInterval));
        carousel.addEventListener('mouseleave', () => startAutoplay());
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        document.getElementById('alert-container').appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 3000);
    }

/*  Modal open/close */
function openCreateModal() {
  // reset form UI each time
  document.getElementById('postForm').reset();
  document.getElementById('postFormErrors').textContent = '';
  // clear selected clubs/tags
  document.getElementById('selectedClubs').innerHTML = '';
  document.getElementById('clubHiddenInputs').innerHTML = '';
  document.getElementById('clubHelper').textContent = 'You may select up to 3 clubs. (0 selected)';
  // reset images
  const imagesList = document.getElementById('imagesList');
  imagesList.querySelectorAll('div:not(#imageRowTemplate)').forEach(n => n.remove());
  addImageRow();

  document.getElementById('createPostModal').classList.remove('hidden');
}
function closeModal() {
  document.getElementById('createPostModal').classList.add('hidden');
}

/* Club search + tag system  */
(function(){ 
  const allClubsEl = Array.from(document.querySelectorAll('#allClubsData .club-data'))
    .map(el => ({ id: el.dataset.id, name: el.dataset.name }));

  const dropdown = document.getElementById('clubDropdown');
  const searchInput = document.getElementById('clubSearchInput');
  const selectedClubsEl = document.getElementById('selectedClubs');
  const hiddenInputs = document.getElementById('clubHiddenInputs');
  const helper = document.getElementById('clubHelper');

  let selected = []; // array of {id,name}

  function renderHelper() {
    helper.textContent = `You may select up to 3 clubs. (${selected.length} selected)`;
  }

  function renderDropdown(matches) {
    dropdown.innerHTML = '';
    if (!matches.length) { dropdown.classList.add('hidden'); return; }
    matches.forEach(c => {
      const row = document.createElement('div');
      row.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
      row.textContent = c.name;
      row.dataset.id = c.id;
      row.addEventListener('click', () => {
        addClub(c);
        dropdown.classList.add('hidden');
        searchInput.value = '';
      });
      dropdown.appendChild(row);
    });

    dropdown.classList.remove('hidden');
  }

  function addClub(c) {
    if (selected.find(s => s.id === c.id)) return;
    if (selected.length >= 3) {
      showAlert('You can only select up to 3 clubs', 'error');
      return;
    }
    selected.push(c);
    // create tag
    const chip = document.createElement('div');
    chip.className = 'inline-flex items-center gap-2 bg-white border rounded px-2 py-1 text-sm';
    chip.innerHTML = `<span>${c.name}</span><button type="button" class="text-red-600 text-sm">✕</button>`;
    chip.querySelector('button').addEventListener('click', () => {
      removeClub(c.id);
    });
    selectedClubsEl.appendChild(chip);
    // hidden input
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'clubs';
    input.value = c.id;
    input.dataset.clubId = c.id;
    hiddenInputs.appendChild(input);
    renderHelper();
  }

  function removeClub(id) {
    selected = selected.filter(s => s.id !== id);

    Array.from(selectedClubsEl.children).forEach(child => {
      if (child.textContent.includes(id) === false) {

      }
    });

    const inp = hiddenInputs.querySelector(`input[data-club-id="${id}"]`);
    if (inp) inp.remove();

    Array.from(selectedClubsEl.children).forEach(child => {
      const txt = child.querySelector('span')?.textContent || '';
      const found = allClubsEl.find(c => c.id === id && c.name === txt);
      if (found) child.remove();
    });
    // fallback
    selectedClubsEl.querySelectorAll('div').forEach(div => {
      const txt = div.querySelector('span')?.textContent || '';
      if (!selected.find(s => s.name === txt)) div.remove();
    });

    renderHelper();
  }

  // search handler
  searchInput.addEventListener('input', (e) => {
    const q = e.target.value.trim().toLowerCase();
    if (!q) { dropdown.classList.add('hidden'); return; }
    const matches = allClubsEl.filter(c => c.name.toLowerCase().includes(q));
    renderDropdown(matches);
  });

  // click outside closes dropdown
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });
})();

/*  Images rows (URL + caption) */
(function(){
  const template = document.getElementById('imageRowTemplate');
  const imagesList = document.getElementById('imagesList');
  const addBtn = document.getElementById('addImageRowBtn');

  window.addImageRow = function(url='', caption='') {
    const clone = template.cloneNode(true);
    clone.style.display = '';
    clone.id = '';
    const urlInput = clone.querySelector('input[name="image_urls"]');
    const capInput = clone.querySelector('input[name="image_captions"]');
    urlInput.value = url;
    capInput.value = caption;
    imagesList.appendChild(clone);
    updateRemoveButtons();
  };

  window.removeImageRow = function(btn) {
    const row = btn.closest('div');

    const rows = Array.from(imagesList.children).filter(n => n.style.display !== 'none' && n.id !== 'imageRowTemplate');
    if (rows.length <= 1) {

      row.querySelector('input[name="image_urls"]').value = '';
      row.querySelector('input[name="image_captions"]').value = '';
      return;
    }
    row.remove();
  };

  addBtn.addEventListener('click', () => addImageRow());

  if (!imagesList.querySelector('div:not(#imageRowTemplate)')) addImageRow();

  function updateRemoveButtons() {
 
    const rows = Array.from(imagesList.children).filter(n => n.style.display !== 'none' && n.id !== 'imageRowTemplate');
    rows.forEach((r, i) => {
      const btn = r.querySelector('button');
      btn.style.display = rows.length > 1 ? '' : 'none';
    });
  }
})();

/* Submit AJAX */
document.getElementById('submitPostBtn').addEventListener('click', async function(){
  const errorsEl = document.getElementById('postFormErrors');
  errorsEl.textContent = '';

  const formEl = document.getElementById('postForm');
  const title = formEl.querySelector('[name="title"]').value.trim();
  const content = formEl.querySelector('[name="content"]').value.trim();
  if (!title || !content) {
    errorsEl.textContent = 'Title and content are required.';
    return;
  }
  const clubInputs = Array.from(document.querySelectorAll('#clubHiddenInputs input[name="clubs"]'));
  if (clubInputs.length > 3) {
    errorsEl.textContent = 'You may select up to 3 clubs only.';
    return;
  }

  // prepare FormData directly from form
  const fd = new FormData(formEl);

  try {
    const res = await fetch("{% url 'forum:create_post' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: fd
    });
    const j = await res.json();
    if (j.success) {
      showAlert('Post created!', 'success');
      closeModal();
      setTimeout(() => location.reload(), 600);
    } else {
      if (j.errors) {
        let out = '';
        for (const [k,v] of Object.entries(j.errors)) out += `${k}: ${Array.isArray(v)? v.join(', '): v}\n`;
        errorsEl.textContent = out;
      } else {
        errorsEl.textContent = j.error || 'Failed to create post';
      }
    }
  } catch (err) {
    errorsEl.textContent = 'Network error';
  }
});
 
    // Filter handling
    document.getElementById('filterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const params = new URLSearchParams();
        
        // Get all checked clubs
        const clubs = [];
        document.querySelectorAll('input[name="clubs"]:checked').forEach(cb => {
            clubs.push(cb.value);
        });
        clubs.forEach(club => params.append('clubs', club));
        
        const league = formData.get('league');
        const search = formData.get('search');
        
        if (league) params.append('league', league);
        if (search) params.append('search', search);
        
        window.location.href = '{% url "forum:forum_home" %}?' + params.toString();
    });
    
    function clearFilters() {
        window.location.href = '{% url "forum:forum_home" %}';
    }
    
    function addImageInput() {
        const container = document.getElementById('imagesContainer');
        const div = document.createElement('div');
        div.className = 'image-input';
        div.innerHTML = `
            <input type="url" class="image-url" placeholder="https://example.com/image.jpg">
            <input type="text" class="image-caption" placeholder="Caption">
            <button type="button" class="btn-remove-image" onclick="removeImageInput(this)">Remove Image</button>
        `;
        container.appendChild(div);
    }
    
    function removeImageInput(btn) {
        btn.closest('.image-input').remove();
    }
    
document.getElementById('postForm')?.addEventListener('submit', async function (e) {
  e.preventDefault();
  const formEl = e.target;
  const formData = new FormData(formEl);

  try {
    const res = await fetch("{% url 'forum:create_post' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: formData
    });
    const data = await res.json();

    if (data.success) {
      showAlert("Post created successfully!", "success");
      closeModal();
      setTimeout(() => location.reload(), 800);
    } else {
      let errMsg = "";
      if (data.errors) {
        for (const [field, messages] of Object.entries(data.errors)) {
          errMsg += `${field}: ${messages.join(", ")}\n`;
        }
      } else {
        errMsg = data.error || "An error occurred";
      }
      showAlert(errMsg, "error");
    }
  } catch (error) {
    showAlert("Failed to submit. Please try again.", "error");
  }
});
</script>
{% endblock %}