{% extends 'statisticsrafi/base.html' %}

{% block title %}Voting Results{% endblock %}

{% block content %}
<style>
    .back-button {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 2rem;
        background: var(--color-orange-300);
        color: white;
        text-decoration: none;
        border-radius: 50px;
        font-family: var(--font-subheader);
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(254, 152, 0, 0.4);
        transition: transform 0.2s ease-in-out;
        z-index: 100;
    }
    
    .back-button:hover {
        transform: translateY(-2px);
    }
</style>
<div class="text-center mb-2">
    <h1>Voting Results</h1>
    {% if category %}
        <h2>{{ category|title|cut:"_" }} - {{ season }}</h2>
    {% else %}
        <h2>Club of the Season - {{ season }}</h2>
    {% endif %}
    <p style="font-size: 1.1rem; color: var(--color-gray-600);">
        Total Votes: <strong>{{ total_votes }}</strong>
    </p>
    
    {% if user.is_authenticated and user_vote %}
        <div id="userVoteInfo" style="background: var(--color-orange-50); padding: 1rem; border-radius: 8px; margin-top: 1rem; display: inline-block;">
            <div style="display: flex; align-items: center; gap: 1rem; justify-content: center;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    {% if user_vote.club.logo_url %}
                        <img src="{{ user_vote.club.logo_url }}" alt="{{ user_vote.club.name }}" style="width: 32px; height: 32px; object-fit: contain;">
                    {% endif %}
                    <span style="font-weight: bold;">Your vote: <span style="color: var(--color-orange-300);">{{ user_vote.club.name }}</span></span>
                </div>
                <button id="deleteVoteBtn" onclick="deleteVote()" style="background: #dc2626; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                    Delete Vote
                </button>
            </div>
            <div id="deleteVoteMessage" style="margin-top: 0.5rem; font-size: 0.9rem; display: none;"></div>
        </div>
    {% elif user.is_authenticated %}
        <p style="color: var(--color-gray-600); font-size: 0.95rem; margin-top: 0.5rem;">
            You haven't voted yet for this season.
        </p>
    {% endif %}
</div>

<div class="card">
    <div class="card-header">Vote Standings</div>
    
    {% if results or vote_counts %}
    <table>
        <thead>
            <tr>
                <th>Rank</th>
                {% if category and 'PLAYER' in category %}
                    <th>Player</th>
                    <th>Club</th>
                {% else %}
                    <th>Club</th>
                    <th>League</th>
                {% endif %}
                <th>Votes</th>
                <th>Percentage</th>
            </tr>
        </thead>
        <tbody>
            {% if results %}
                {% for result in results %}
                <tr>
                    <td><strong style="color: var(--color-orange-300);">#{{ forloop.counter }}</strong></td>
                    {% if 'PLAYER' in category %}
                        <td><strong>{{ result.player__name }}</strong></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                {% if result.player__club__logo_url %}
                                    <img src="{{ result.player__club__logo_url }}" alt="{{ result.player__club__name }}" style="width: 24px; height: 24px; object-fit: contain;">
                                {% endif %}
                                <span>{{ result.player__club__name }}</span>
                            </div>
                        </td>
                    {% else %}
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                {% if result.club__logo_url %}
                                    <img src="{{ result.club__logo_url }}" alt="{{ result.club__name }}" style="width: 24px; height: 24px; object-fit: contain;">
                                {% endif %}
                                <strong>{{ result.club__name }}</strong>
                            </div>
                        </td>
                        <td>{{ result.club__league__name|default:"-" }}</td>
                    {% endif %}
                    <td><span style="color: var(--color-orange-300); font-weight: bold; font-size: 1.1rem;">{{ result.vote_count }}</span></td>
                    <td>
                        {% widthratio result.vote_count total_votes 100 %}%
                        <div style="background: var(--color-gray-400); height: 8px; border-radius: 4px; margin-top: 0.3rem; overflow: hidden;">
                            <div style="background: var(--color-orange-300); height: 100%; width: {% widthratio result.vote_count total_votes 100 %}%;"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% elif vote_counts %}
                {% for vote_count in vote_counts %}
                <tr>
                    <td><strong style="color: var(--color-orange-300);">#{{ forloop.counter }}</strong></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            {% if vote_count.club__logo_url %}
                                <img src="{{ vote_count.club__logo_url }}" alt="{{ vote_count.club__name }}" style="width: 24px; height: 24px; object-fit: contain;">
                            {% endif %}
                            <strong>{{ vote_count.club__name }}</strong>
                        </div>
                    </td>
                    <td>{{ vote_count.club__league__name|default:"-" }}</td>
                    <td><span style="color: var(--color-orange-300); font-weight: bold; font-size: 1.1rem;">{{ vote_count.vote_count }}</span></td>
                    <td>
                        {% widthratio vote_count.vote_count total_votes 100 %}%
                        <div style="background: var(--color-gray-400); height: 8px; border-radius: 4px; margin-top: 0.3rem; overflow: hidden;">
                            <div style="background: var(--color-orange-300); height: 100%; width: {% widthratio vote_count.vote_count total_votes 100 %}%;"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% endif %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: var(--color-gray-600); padding: 3rem;">
        No votes have been cast yet. Be the first to vote!
    </p>
    {% endif %}
</div>

<!-- Floating Back Button -->
<a href="{% url 'statisticsrafi:home' %}" class="back-button">
    ‚Üê Back to Home
</a>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function deleteVote() {
    const deleteBtn = document.getElementById('deleteVoteBtn');
    const messageDiv = document.getElementById('deleteVoteMessage');
    
    // Disable button during request
    deleteBtn.disabled = true;
    deleteBtn.textContent = 'Deleting...';
    
    // Send delete request
    fetch('{% url "statisticsrafi:delete_vote" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'season={{ season }}'
    })
    .then(response => response.json())
    .then(data => {
        messageDiv.style.display = 'block';
        
        if (data.status === 'success') {
            messageDiv.innerHTML = `<div style="color: #4ade80;">‚úÖ ${data.message}</div>`;
            deleteBtn.textContent = '‚úÖ Deleted!';
            deleteBtn.style.background = 'rgba(74, 222, 128, 0.3)';
            
            // Hide the user vote info after a short delay
            setTimeout(() => {
                const userVoteInfo = document.getElementById('userVoteInfo');
                if (userVoteInfo) {
                    userVoteInfo.style.transition = 'opacity 0.5s';
                    userVoteInfo.style.opacity = '0';
                    setTimeout(() => {
                        userVoteInfo.style.display = 'none';
                        location.reload();
                    }, 500);
                }
            }, 1500);
        } else {
            messageDiv.innerHTML = `<div style="color: #dc2626;">‚ùå ${data.message}</div>`;
            deleteBtn.disabled = false;
            deleteBtn.textContent = 'üóëÔ∏è Delete Vote';
            deleteBtn.style.background = '#dc2626';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        messageDiv.style.display = 'block';
        messageDiv.innerHTML = `<div style="color: #dc2626;">‚ùå An error occurred while deleting your vote.</div>`;
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'üóëÔ∏è Delete Vote';
        deleteBtn.style.background = '#dc2626';
    });
}
</script>

{% endblock %}





