{% extends 'matchpredictions/base.html' %}
{% load static %}

{% block title %}Match Predictions{% endblock %}

{% block content %}
  <!-- üèüÔ∏è Match Predictions -->
  <section class="text-center mb-8">
    <h1 class="text-3xl font-extrabold text-gray-800">Match Predictions</h1>
    <p class="text-gray-500 text-sm mt-1">Vote for your favorite club and see what others predict!</p>
  </section>

  <!-- üèÜ League Buttons -->
  <section class="text-center mb-10">
    <div id="league-buttons" class="flex flex-wrap justify-center gap-4 mb-6">
      <!-- All Leagues -->
      <button data-league="" 
              class="league-btn flex items-center gap-2 px-5 py-2 rounded-full text-sm font-medium transition transform
                     {% if not selected_league_id %}
                        bg-indigo-600 text-white scale-105 shadow-md
                     {% else %}
                        bg-gray-200 hover:bg-indigo-100 text-gray-700
                     {% endif %}">
        üåç All Leagues
      </button>

      {% for league in leagues %}
        <button data-league="{{ league.id }}"
                class="league-btn flex items-center gap-2 px-5 py-2 rounded-full text-sm font-medium transition transform
                       {% if selected_league_id|stringformat:'s' == league.id|stringformat:'s' %}
                          bg-gradient-to-r from-orange-500 to-yellow-400 text-white scale-105 shadow-md
                       {% else %}
                          bg-gray-100 hover:bg-orange-100 text-gray-800
                       {% endif %}">

          {% if league.name == "Premier League" %}
            <img src="{% static 'images/leagues/premier_league.png' %}" alt="Premier League" class="w-6 h-6 rounded-full border border-gray-300 bg-white p-0.5 object-contain">
          {% elif league.name == "La Liga" %}
            <img src="{% static 'images/leagues/la_liga.png' %}" alt="La Liga" class="w-6 h-6 rounded-full border border-gray-300 bg-white p-0.5 object-contain">
          {% elif league.name == "Serie A" %}
            <img src="{% static 'images/leagues/serie_a.png' %}" alt="Serie A" class="w-6 h-6 rounded-full border border-gray-300 bg-white p-0.5 object-contain">
          {% elif league.name == "Bundesliga" %}
            <img src="{% static 'images/leagues/bundesliga.png' %}" alt="Bundesliga" class="w-6 h-6 rounded-full border border-gray-300 bg-white p-0.5 object-contain">
          {% elif league.name == "Ligue 1" %}
            <img src="{% static 'images/leagues/ligue_1.png' %}" alt="Ligue 1" class="w-6 h-6 rounded-full border border-gray-300 bg-white p-0.5 object-contain">
          {% else %}
            <img src="{% static 'images/leagues/default.png' %}" alt="{{ league.name }}" class="w-6 h-6 rounded-full border border-gray-300 bg-white p-0.5 object-contain">
          {% endif %}

          {{ league.name }}
        </button>
      {% endfor %}
    </div>

    <!-- üîç Search Bar -->
    <div class="flex justify-center">
      <input type="text" id="search-input" 
             placeholder="Search your favorite club..."
             class="w-full sm:w-1/2 px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-400 transition" />
    </div>
  </section>

  <!-- üë®‚Äçüíº Admin Add Button -->
  {% if user.is_staff %}
  <div class="flex justify-end mb-8">
    <a href="{% url 'match_create' %}" 
       class="bg-gradient-to-r from-orange-500 to-yellow-400 hover:from-orange-600 hover:to-yellow-500 text-white px-6 py-2 rounded-lg font-medium transition shadow">
       ‚ûï Add Match
    </a>
  </div>
  {% endif %}
</a>

  <!-- ‚öΩ Match Cards -->
  <div id="match-container">
    {% include 'matchpredictions/match_list.html' %}
  </div>

  <!-- üåô Login Modal -->
  <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex justify-center items-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-80 text-center relative animate-fadeIn">
      <h2 class="text-xl font-bold text-gray-800 mb-2">Login Required</h2>
      <p class="text-gray-600 text-sm mb-6">You need to be logged in to vote for matches.</p>
      <div class="flex justify-center gap-3">
        <a href="/login/" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-medium transition">Login</a>
        <button id="close-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded-lg font-medium transition">Cancel</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeIn {
    animation: fadeIn 0.3s ease-out;
  }
</style>

<!-- ‚úÖ AJAX + Modal + Search -->
<script>
$(document).ready(function() {
  // ‚úÖ League AJAX switch
  $('.league-btn').on('click', function() {
    const leagueId = $(this).data('league');
    $.ajax({
      url: "{% url 'main' %}",
      data: { league: leagueId },
      success: function(response) {
        const newMatches = $(response).find('#match-container').html();
        $('#match-container').html(newMatches);
      }
    });
  });

  // ‚úÖ Search bar
  $('#search-input').on('keyup', function() {
    const query = $(this).val();
    const leagueId = $('.league-btn.bg-indigo-600').data('league') || '';
    $.ajax({
      url: "{% url 'main' %}",
      data: { search: query, league: leagueId },
      success: function(response) {
        const filteredMatches = $(response).find('#match-container').html();
        $('#match-container').html(filteredMatches);
      }
    });
  });

  // ‚úÖ Modal logic
  const modal = $('#login-modal');
  const closeModal = $('#close-modal');

  {% if not user.is_authenticated %}
    $(document).on('click', '.vote-btn', function(e) {
      e.preventDefault();
      modal.removeClass('hidden').hide().fadeIn(200);
    });

    closeModal.on('click', function() {
      modal.fadeOut(200, function() {
        modal.addClass('hidden');
      });
    });

    $(document).on('click', function(e) {
      if ($(e.target).is(modal)) {
        modal.fadeOut(200, function() {
          modal.addClass('hidden');
        });
      }
    });
  {% endif %}
});

// ‚úÖ AJAX voting
$(document).on('click', '.vote-btn', function (e) {
  e.preventDefault();
  const button = $(this);
  const matchId = button.data('id');
  const url = button.attr('href');

  $.ajax({
    url: url,
    type: 'POST',
    data: {
      prediction: 'home_win', // or capture from UI buttons later
      csrfmiddlewaretoken: '{{ csrf_token }}'
    },
    success: function (response) {
      const msgEl = $(`#vote-message-${matchId}`);
      msgEl
        .removeClass('hidden text-red-500 text-green-600')
        .addClass(response.already_voted ? 'text-red-500' : 'text-green-600')
        .text(response.message)
        .fadeIn(200)
        .delay(2500)
        .fadeOut(400);
    },
    error: function () {
      alert("Something went wrong. Please try again.");
    }
  });
});

</script>
{% endblock %}

