{% extends 'matchpredictions/base.html' %}
{% load static %}

{% block title %}{{ match.home_team.name }} vs {{ match.away_team.name }}{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl p-10 border border-gray-200 relative overflow-hidden">

  <!--  Local Notifications -->
  {% if messages %}
    <div id="local-messages" class="mb-6 space-y-2 animate-fade-in">
      {% for message in messages %}
        <div class="px-4 py-3 rounded-lg shadow-md border transition-all transform hover:scale-[1.02]
                    {% if message.tags == 'success' %}
                      bg-green-100 border-green-300 text-green-800
                    {% elif message.tags == 'error' %}
                      bg-red-100 border-red-300 text-red-800
                    {% elif message.tags == 'warning' %}
                      bg-yellow-100 border-yellow-300 text-yellow-800
                    {% else %}
                      bg-gray-100 border-gray-300 text-gray-800
                    {% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>

    <script>
      //  Auto-hide notifications after 3 seconds
      setTimeout(() => {
        const msgBox = document.getElementById('local-messages');
        if (msgBox) msgBox.remove();
      }, 3000);
    </script>
  {% endif %}

  <!-- Decorative background -->
  <div class="absolute inset-0 opacity-5 pointer-events-none"
       style="background: radial-gradient(circle at 30% 20%, #fe9800 0, transparent 60%);"></div>

  <!--  Match Header -->
  <section class="relative z-10 flex justify-between items-center mb-10">
    <div class="flex flex-col items-center w-1/3">
      <img src="{{ match.home_team.logo_url }}" alt="{{ match.home_team.name }}"
           class="w-28 h-28 mb-3 rounded-full border-4 border-orange-200 shadow-md bg-white p-2 transform transition hover:scale-105">
      <h2 class="text-xl font-bold text-gray-800">{{ match.home_team.name }}</h2>
    </div>

    <div class="text-center w-1/3">
      <p class="text-4xl font-extrabold text-orange-500 drop-shadow mb-1">VS</p>
      <p class="text-sm text-gray-600">{{ match.match_date|date:"D, M d, Y H:i" }}</p>
      <p class="text-xs text-gray-500 uppercase tracking-wide mt-2 bg-gray-100 px-3 py-1 inline-block rounded-full shadow-sm">
        {{ match.status }}
      </p>
    </div>

    <div class="flex flex-col items-center w-1/3">
      <img src="{{ match.away_team.logo_url }}" alt="{{ match.away_team.name }}"
           class="w-28 h-28 mb-3 rounded-full border-4 border-orange-200 shadow-md bg-white p-2 transform transition hover:scale-105">
      <h2 class="text-xl font-bold text-gray-800">{{ match.away_team.name }}</h2>
    </div>
  </section>

  <hr class="my-10 border-gray-300">

  <!--  Voting Section -->
  <section class="relative z-10 text-center">
    <h3 class="text-2xl font-semibold mb-6 text-gray-800">Cast Your Prediction</h3>

    {% if user.is_authenticated %}
      <form id="voteForm" method="POST" action="{% url 'matchpredictions:vote_match' match.id %}" class="flex flex-col items-center">
        {% csrf_token %}
        <div class="flex gap-6 mb-4 flex-wrap justify-center">

          <!-- Home Win -->
          <button type="button" name="prediction" value="home_win"
            {% if user_vote %}disabled{% endif %}
            class="vote-btn px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105
                   {% if user_vote and user_vote.prediction == 'home_win' %}
                      bg-gray-400 text-white cursor-not-allowed
                   {% elif user_vote %}
                      bg-gray-300 text-gray-500 cursor-not-allowed
                   {% else %}
                      bg-gradient-to-r from-green-500 to-green-400 hover:from-green-600 hover:to-green-500 text-white shadow-md
                   {% endif %}">
            {{ match.home_team.name }} Win
          </button>

          <!-- Draw -->
          <button type="button" name="prediction" value="draw"
            {% if user_vote %}disabled{% endif %}
            class="vote-btn px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105
                   {% if user_vote and user_vote.prediction == 'draw' %}
                      bg-gray-400 text-white cursor-not-allowed
                   {% elif user_vote %}
                      bg-gray-300 text-gray-500 cursor-not-allowed
                   {% else %}
                      bg-gradient-to-r from-yellow-500 to-yellow-400 hover:from-yellow-600 hover:to-yellow-500 text-white shadow-md
                   {% endif %}">Draw</button>

          <!-- Away Win -->
          <button type="button" name="prediction" value="away_win"
            {% if user_vote %}disabled{% endif %}
            class="vote-btn px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105
                   {% if user_vote and user_vote.prediction == 'away_win' %}
                      bg-gray-400 text-white cursor-not-allowed
                   {% elif user_vote %}
                      bg-gray-300 text-gray-500 cursor-not-allowed
                   {% else %}
                      bg-gradient-to-r from-blue-500 to-blue-400 hover:from-blue-600 hover:to-blue-500 text-white shadow-md
                   {% endif %}">
            {{ match.away_team.name }} Win
          </button>
        </div>

        {% if user_vote %}
        <div class="mt-6 px-5 py-4 bg-orange-50 border-l-4 border-orange-400 rounded-lg shadow-sm text-left animate-fade-in">
          <p class="text-orange-700 font-medium">ðŸŸ¢ You have already voted for this match!</p>
          <p class="text-sm text-gray-700 mt-1">
            Your prediction:
            <span class="font-semibold text-orange-600">
              {% if user_vote.prediction == "home_win" %}
                {{ match.home_team.name }} Win
              {% elif user_vote.prediction == "away_win" %}
                {{ match.away_team.name }} Win
              {% else %}
                Draw
              {% endif %}
            </span>
          </p>

          <div class="flex gap-3 mt-4">
            <a href="{% url 'matchpredictions:edit_vote' match.id %}"
               class="px-4 py-2 rounded-lg bg-yellow-500 hover:bg-yellow-600 text-white font-medium shadow transition">
               Edit Vote
            </a>
            <a href="{% url 'matchpredictions:delete_vote' match.id %}"
               class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium shadow transition">
               Delete Vote
            </a>
          </div>
        </div>
        {% endif %}
      </form>
    {% else %}
      <p class="text-center mt-6 text-gray-600">
        <a href="{% url 'main:login' %}?next={{ request.path }}" class="text-orange-500 hover:text-orange-600 font-medium underline">
          Login
        </a> to participate in match predictions.
      </p>
    {% endif %}
  </section>

  <hr class="my-10 border-gray-300">

  <!--  Fan Voting Results -->
  <section class="relative z-10 text-center">
    <h4 class="text-2xl font-semibold mb-8 text-gray-800">Fan Voting Results</h4>

    {% if total_votes > 0 %}
    <div class="space-y-6 text-left">
      <div>
        <div class="flex justify-between mb-1">
          <p class="font-semibold text-gray-700">{{ match.home_team.name }} Win</p>
          <p class="text-sm text-gray-600">{{ vote_summary.home_win }}% ({{ home_votes }} votes)</p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden shadow-inner">
          <div class="bg-green-500 h-5 rounded-full text-xs font-bold text-white text-right pr-2 transition-all duration-700 ease-out"
               style="width: {{ vote_summary.home_win }}%">{{ vote_summary.home_win }}%</div>
        </div>
      </div>

      <div>
        <div class="flex justify-between mb-1">
          <p class="font-semibold text-gray-700">Draw</p>
          <p class="text-sm text-gray-600">{{ vote_summary.draw }}% ({{ draw_votes }} votes)</p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden shadow-inner">
          <div class="bg-yellow-500 h-5 rounded-full text-xs font-bold text-white text-right pr-2 transition-all duration-700 ease-out"
               style="width: {{ vote_summary.draw }}%">{{ vote_summary.draw }}%</div>
        </div>
      </div>

      <div>
        <div class="flex justify-between mb-1">
          <p class="font-semibold text-gray-700">{{ match.away_team.name }} Win</p>
          <p class="text-sm text-gray-600">{{ vote_summary.away_win }}% ({{ away_votes }} votes)</p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden shadow-inner">
          <div class="bg-blue-500 h-5 rounded-full text-xs font-bold text-white text-right pr-2 transition-all duration-700 ease-out"
               style="width: {{ vote_summary.away_win }}%">{{ vote_summary.away_win }}%</div>
        </div>
      </div>

      <p class="text-sm text-gray-500 italic mt-4 text-center">
        Total votes: <span class="font-semibold">{{ total_votes }}</span> fans
      </p>
    </div>
    {% else %}
      <p class="text-gray-500 text-sm italic">No votes have been cast yet.</p>
    {% endif %}
  </section>

  <div class="text-center mt-10 relative z-10">
    <a href="{% url 'matchpredictions:main' %}"
     class="inline-flex items-center gap-2 bg-gradient-to-r from-orange-500 to-yellow-400 hover:from-orange-600 hover:to-yellow-500 text-black font-semibold px-6 py-3 rounded-xl shadow-lg transition transform hover:scale-105 hover:shadow-xl">
      Back to Matches
    </a>

  </div>
</main>

<!--  Confirmation Modal -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-2xl shadow-xl p-6 max-w-lg w-full mx-4 animate-fade-in">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">Confirm Your Vote</h3>
    <p id="confirmText" class="text-gray-600 mb-5">Are you sure you want to vote?</p>
    <div class="flex flex-col sm:flex-row justify-end gap-3">
      <button id="cancelBtn" type="button"
              class="w-full sm:w-auto px-5 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 shadow transition">
        Cancel
      </button>
      <button id="confirmBtn" type="button" autofocus
              class="w-full sm:w-auto px-5 py-2 rounded-lg bg-gradient-to-r from-yellow-400 to-yellow-300 text-black font-semibold hover:from-yellow-500 hover:to-yellow-400 shadow-md transition">
        Confirm
      </button>
    </div>
  </div>
</div>

<style>
@keyframes fade-in {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in { animation: fade-in 0.3s ease-in-out; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const buttons = document.querySelectorAll(".vote-btn");
  const modal = document.getElementById("confirmModal");
  const confirmText = document.getElementById("confirmText");
  const confirmBtn = document.getElementById("confirmBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const form = document.getElementById("voteForm");
  let selectedPrediction = null;

  buttons.forEach(btn => {
    btn.addEventListener("click", function() {
      if (this.disabled) return;
      selectedPrediction = this.value;
      const teamName = this.textContent.trim();
      confirmText.textContent = `Are you sure you want to vote for "${teamName}"?`;
      modal.classList.remove("hidden");
      confirmBtn.focus();
    });
  });

  function closeModal() {
    modal.classList.add("hidden");
    selectedPrediction = null;
    confirmBtn.disabled = false;
  }

  cancelBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal.classList.contains("hidden")) closeModal();
  });

  confirmBtn.addEventListener("click", () => {
    if (!selectedPrediction) return;
    const existing = form.querySelector('input[name="prediction"][type="hidden"]');
    if (existing) existing.remove();
    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.name = "prediction";
    hiddenInput.value = selectedPrediction;
    form.appendChild(hiddenInput);
    confirmBtn.disabled = true;
    form.submit();
  });
});
</script>
{% endblock %}
