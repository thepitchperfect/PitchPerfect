{% extends 'matchpredictions/base.html' %}
{% load static %}

{% block title %}{{ match.home_team.name }} vs {{ match.away_team.name }}{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl p-10 border border-gray-200 relative overflow-hidden">

  <!-- Decorative background -->
  <div class="absolute inset-0 opacity-5 pointer-events-none"
       style="background: radial-gradient(circle at 30% 20%, #fe9800 0, transparent 60%);"></div>

  <!-- üèüÔ∏è Match Header -->
  <section class="relative z-10 flex justify-between items-center mb-10">
    <!-- Home -->
    <div class="flex flex-col items-center w-1/3">
      <img src="{{ match.home_team.logo_url }}" alt="{{ match.home_team.name }}"
           class="w-28 h-28 mb-3 rounded-full border-4 border-orange-200 shadow-md bg-white p-2 transform transition hover:scale-105">
      <h2 class="text-xl font-bold text-gray-800">{{ match.home_team.name }}</h2>
    </div>

    <!-- VS -->
    <div class="text-center w-1/3">
      <p class="text-4xl font-extrabold text-orange-500 drop-shadow mb-1">VS</p>
      <p class="text-sm text-gray-600">{{ match.match_date|date:"D, M d, Y H:i" }}</p>
      <p class="text-xs text-gray-500 uppercase tracking-wide mt-2 bg-gray-100 px-3 py-1 inline-block rounded-full shadow-sm">
        {{ match.status }}
      </p>
    </div>

    <!-- Away -->
    <div class="flex flex-col items-center w-1/3">
      <img src="{{ match.away_team.logo_url }}" alt="{{ match.away_team.name }}"
           class="w-28 h-28 mb-3 rounded-full border-4 border-orange-200 shadow-md bg-white p-2 transform transition hover:scale-105">
      <h2 class="text-xl font-bold text-gray-800">{{ match.away_team.name }}</h2>
    </div>
  </section>

  <!-- üìä Team Stats + Chart -->
  <section class="relative z-10 text-center mb-10">
    <h3 class="text-2xl font-semibold mb-6 text-gray-800">Team Statistics</h3>

    <!-- Stats Summary -->
    <div class="grid grid-cols-3 text-sm font-medium text-gray-700 mb-8">
      <!-- Home Stats -->
      <div class="text-left">
        {% if home_stats %}
          <p>üèÜ Wins: {{ home_stats.wins }}</p>
          <p>ü§ù Draws: {{ home_stats.draws }}</p>
          <p>‚ùå Losses: {{ home_stats.losses }}</p>
          <p>‚öΩ Scored / Match: {{ home_stats.goals_per_match }}</p>
          <p>üìà Avg Goals: {{ home_stats.avg_goals }}</p>
        {% else %}
          <p class="text-gray-500 italic">No data available.</p>
        {% endif %}
      </div>

      <div class="text-center flex flex-col justify-center text-gray-500">
        <p class="text-xl font-bold text-orange-500 mb-1">VS</p>
        <p class="text-xs">Stat Comparison</p>
      </div>

      <!-- Away Stats -->
      <div class="text-right">
        {% if away_stats %}
          <p>üèÜ Wins: {{ away_stats.wins }}</p>
          <p>ü§ù Draws: {{ away_stats.draws }}</p>
          <p>‚ùå Losses: {{ away_stats.losses }}</p>
          <p>‚öΩ Scored / Match: {{ away_stats.goals_per_match }}</p>
          <p>üìà Avg Goals: {{ away_stats.avg_goals }}</p>
        {% else %}
          <p class="text-gray-500 italic">No data available.</p>
        {% endif %}
      </div>
    </div>

    <!-- Horizontal Chart -->
    <div class="relative w-full h-64">
      <canvas id="teamComparisonChart"></canvas>
    </div>
  </section>

  <hr class="my-10 border-gray-300">

  <!-- üó≥Ô∏è Voting Section -->
  <section class="relative z-10 text-center">
    <h3 class="text-2xl font-semibold mb-6 text-gray-800">Cast Your Prediction</h3>

    {% if user.is_authenticated %}
      <form method="POST" action="{% url 'vote_match' match.id %}" class="flex flex-col items-center">
        {% csrf_token %}
        <div class="flex gap-6 mb-4 flex-wrap justify-center">
          <button type="submit" name="prediction" value="home_win"
            class="px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105 
                   {% if user_vote and user_vote.prediction == 'home_win' %}
                      bg-gray-400 text-white cursor-not-allowed
                   {% else %}
                      bg-gradient-to-r from-green-500 to-green-400 hover:from-green-600 hover:to-green-500 text-white shadow-md
                   {% endif %}">
            {{ match.home_team.name }} Win
          </button>

          <button type="submit" name="prediction" value="draw"
            class="px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105
                   {% if user_vote and user_vote.prediction == 'draw' %}
                      bg-gray-400 text-white cursor-not-allowed
                   {% else %}
                      bg-gradient-to-r from-yellow-500 to-yellow-400 hover:from-yellow-600 hover:to-yellow-500 text-white shadow-md
                   {% endif %}">
            Draw
          </button>

          <button type="submit" name="prediction" value="away_win"
            class="px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105
                   {% if user_vote and user_vote.prediction == 'away_win' %}
                      bg-gray-400 text-white cursor-not-allowed
                   {% else %}
                      bg-gradient-to-r from-blue-500 to-blue-400 hover:from-blue-600 hover:to-blue-500 text-white shadow-md
                   {% endif %}">
            {{ match.away_team.name }} Win
          </button>
        </div>

        {% if user_vote %}
          <p class="text-sm text-gray-600 mt-2">
          ‚úÖ You voted:
          <span class="font-semibold text-orange-600">
              {% if user_vote.prediction == "home_win" %}
              {{ match.home_team.name }} Win
              {% elif user_vote.prediction == "away_win" %}
              {{ match.away_team.name }} Win
              {% else %}
              Draw
              {% endif %}
          </span>
          </p>
        {% endif %}
      </form>
    {% else %}
      <p class="text-center mt-6 text-gray-600">
        <a href="{% url 'login' %}" class="text-orange-500 hover:text-orange-600 font-medium underline">
          Login
        </a> to participate in match predictions.
      </p>
    {% endif %}
  </section>

  <hr class="my-10 border-gray-300">

  <!-- üìä Fan Voting Results -->
  <section class="relative z-10 text-center">
    <h4 class="text-2xl font-semibold mb-8 text-gray-800">Fan Voting Results</h4>

    {% if total_votes > 0 %}
    <div class="space-y-6 text-left">
      <div>
        <div class="flex justify-between mb-1">
          <p class="font-semibold text-gray-700">{{ match.home_team.name }} Win</p>
          <p class="text-sm text-gray-600">{{ vote_summary.home_win }}% ({{ home_votes }} votes)</p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden shadow-inner">
          <div class="bg-green-500 h-5 rounded-full text-xs font-bold text-white text-right pr-2 transition-all duration-700 ease-out"
               style="width: {{ vote_summary.home_win }}%">
            {{ vote_summary.home_win }}%
          </div>
        </div>
      </div>

      <div>
        <div class="flex justify-between mb-1">
          <p class="font-semibold text-gray-700">Draw</p>
          <p class="text-sm text-gray-600">{{ vote_summary.draw }}% ({{ draw_votes }} votes)</p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden shadow-inner">
          <div class="bg-yellow-500 h-5 rounded-full text-xs font-bold text-white text-right pr-2 transition-all duration-700 ease-out"
               style="width: {{ vote_summary.draw }}%">
            {{ vote_summary.draw }}%
          </div>
        </div>
      </div>

      <div>
        <div class="flex justify-between mb-1">
          <p class="font-semibold text-gray-700">{{ match.away_team.name }} Win</p>
          <p class="text-sm text-gray-600">{{ vote_summary.away_win }}% ({{ away_votes }} votes)</p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden shadow-inner">
          <div class="bg-blue-500 h-5 rounded-full text-xs font-bold text-white text-right pr-2 transition-all duration-700 ease-out"
               style="width: {{ vote_summary.away_win }}%">
            {{ vote_summary.away_win }}%
          </div>
        </div>
      </div>

      <p class="text-sm text-gray-500 italic mt-4 text-center">
        Total votes: <span class="font-semibold">{{ total_votes }}</span> fans
      </p>
    </div>
    {% else %}
      <p class="text-gray-500 text-sm italic">No votes have been cast yet.</p>
    {% endif %}
  </section>

  <!-- ‚¨ÖÔ∏è Back -->
  <div class="text-center mt-10 relative z-10">
    <a href="{% url 'main' %}"
       class="inline-flex items-center gap-2 bg-gradient-to-r from-orange-500 to-orange-400 hover:from-orange-600 hover:to-orange-500 text-white px-6 py-3 rounded-lg font-medium shadow-md transition transform hover:scale-105">
      ‚¨ÖÔ∏è Back to Matches
    </a>
  </div>
</main>

<!-- üìä Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('teamComparisonChart').getContext('2d');

  const data = {
    labels: ['Wins', 'Draws', 'Losses', 'Goals/Match', 'Avg Goals'],
    datasets: [
      {
        label: '{{ match.home_team.name }}',
        data: [
          {{ home_stats.wins|default:0 }},
          {{ home_stats.draws|default:0 }},
          {{ home_stats.losses|default:0 }},
          {{ home_stats.goals_per_match|default:0 }},
          {{ home_stats.avg_goals|default:0 }}
        ],
        backgroundColor: 'rgba(254, 152, 0, 0.7)',
        borderColor: '#fe9800',
        borderWidth: 1,
        borderSkipped: false,
        barThickness: 18
      },
      {
        label: '{{ match.away_team.name }}',
        data: [
          -{{ away_stats.wins|default:0 }},
          -{{ away_stats.draws|default:0 }},
          -{{ away_stats.losses|default:0 }},
          -{{ away_stats.goals_per_match|default:0 }},
          -{{ away_stats.avg_goals|default:0 }}
        ],
        backgroundColor: 'rgba(128, 128, 128, 0.7)',
        borderColor: '#888',
        borderWidth: 1,
        borderSkipped: false,
        barThickness: 18
      }
    ]
  };

  const chart = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      indexAxis: 'y',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#333', font: { size: 12 } }
        },
      },
      responsive: true,
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: '#eee' },
          ticks: { callback: value => Math.abs(value) }
        },
        y: {
          grid: { color: '#eee' }
        }
      }
    }
  });
</script>
{% endblock %}
